<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Map Quiz</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .map-container { position: relative; }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1;
        }
        .leaflet-container { background: var(--map-bg-color, #a2d2ff); }
        #score-modal, #info-modal, #profile-page { z-index: 1001; }
        .permanent-tooltip {
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: bold;
            color: #1e3a8a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #settings-panel.disabled, .setting-control button.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .combo-heat-max {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        #points-indicator {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: all 0.5s ease-out;
            pointer-events: none;
        }
        #points-indicator.show {
            bottom: 150%;
            opacity: 1;
        }
        .setting-control button {
            transition: all 0.2s ease-in-out;
        }
        /* Style for the active Explore button */
        button[data-value="explore"].active {
            background-color: #16a34a; /* Green tint */
            color: white;
            box-shadow: 0 0 15px 3px rgba(22, 163, 74, 0.6); /* Green glow */
        }
        #country-guess-input:read-only {
            background-color: #e9ecef;
            cursor: default;
        }
        /* Country Info Panel Styling */
        #country-info-panel {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        /* Profile Page Styling */
        .stat-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(209, 213, 219, 0.5);
        }
        .achievement-badge {
            transition: transform 0.2s ease-in-out;
        }
        .achievement-badge.unlocked {
            filter: none;
            opacity: 1;
        }
        .achievement-badge.locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .achievement-badge:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-300">

    <div id="main-container" class="w-full max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-2xl border border-gray-200 transition-colors duration-300">
        <header class="text-center mb-4 relative">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-bold text-blue-900 transition-colors duration-300">World Map Quiz</h1>
            <p id="subtitle" class="text-md sm:text-lg text-gray-600 mt-2 transition-colors duration-300">Select your settings and press Start!</p>
            <div class="absolute top-0 left-0 flex items-center gap-2">
                <button id="back-to-quiz-btn" class="hidden bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition shadow-md">Back to Quiz</button>
                 <button id="profile-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    Profile
                </button>
            </div>
            <div id="explored-counter" class="hidden my-2 md:my-0 md:absolute md:top-0 md:right-0 bg-green-100 text-green-800 font-bold text-xl sm:text-2xl px-4 py-2 rounded-lg shadow-md"></div>
            <div id="score-display" class="hidden absolute top-0 right-0 bg-white bg-opacity-80 text-blue-900 font-bold text-xl sm:text-2xl px-4 py-2 rounded-lg shadow-md">Score: 0</div>
        </header>

        <div id="quiz-content" class="relative">
            <!-- Map container with overlaid quiz panel -->
            <div class="w-full">
                <div class="map-container mb-6 relative">
                    <div class="relative shadow-lg border-2 border-blue-900" style="height: 65vh; border-radius: 0.5rem;">
                        <div id="map" class="w-full h-full"></div>
                        <div id="status-display-container" class="absolute top-3 left-1/2 -translate-x-1/2 z-10 mx-4">
                            <div class="relative w-[100px] h-[50px]">
                                <div class="absolute inset-0 bg-white bg-opacity-90 rounded-lg shadow-md"></div>
                                <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 50">
                                    <path id="timer-progress-bar"
                                          d="M 50,2 L 90,2 A 8,8 0 0 1 98,10 L 98,40 A 8,8 0 0 1 90,48 L 10,48 A 8,8 0 0 1 2,40 L 2,10 A 8,8 0 0 1 10,2 L 50,2"
                                          fill="none" stroke="#3b82f6" stroke-width="4"
                                          style="transition: stroke-dashoffset 0.1s linear;"/>
                                </svg>
                                <div id="timer-display" class="relative w-full h-full flex items-center justify-center text-blue-900 font-bold text-xl">
                                </div>
                            </div>
                        </div>
                        <div id="quiz-controls-container" class="absolute bottom-5 left-1/2 -translate-x-1/2 w-11/12 sm:w-2/3 max-w-lg z-10 text-center">
                             <button id="start-quiz-btn" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-700 transition shadow-md text-xl w-full">Start Quiz</button>
                             <div class="relative flex items-center gap-2">
                                <input type="text" id="country-guess-input" placeholder="Type country name..." class="hidden w-full px-5 py-3 border-2 border-blue-300 rounded-full shadow-lg focus:ring-4 focus:ring-blue-400 focus:outline-none transition text-center text-lg">
                                <button id="learn-btn" class="hidden bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-md text-lg w-auto whitespace-nowrap">Explore</button>
                                <div id="points-indicator"></div>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Country Info Panel -->
                    <div id="country-info-panel" class="absolute top-4 left-4 bottom-4 max-w-sm flex flex-col bg-white p-6 rounded-lg shadow-lg opacity-0 -translate-x-4 pointer-events-none z-20 transition-all duration-300 md:absolute md:top-4 md:left-4 max-md:relative max-md:top-0 max-md:left-0 max-md:w-full max-md:max-w-none max-md:mt-4 max-md:translate-x-0">
                        <h2 id="country-info-name" class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                            <span>Select a Country</span>
                            <button id="speak-country-name" class="ml-2 text-gray-500 hover:text-gray-700 focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 12H4a1 1 0 00-1 1v2a1 1 0 001 1h1.858l4.293 4.293a1 1 0 001.414-1.414L7.272 13.414A1 1 0 007.272 12a1 1 0 000-1.414L11.566 6.142a1 1 0 00-1.414-1.414L5.858 9H4a1 1 0 00-1 1v2a1 1 0 001 1h1.858l4.293 4.293a1 1 0 001.414 0L12 13.464l-4.293-4.293a1 1 0 00-1.414 0z" />
                                </svg>
                            </button>
                        </h2>
                        <p id="country-info-bio" class="text-gray-700 text-base leading-relaxed mb-4">Click on a country on the map or use the 'Explore' button to discover interesting facts!</p>
                        
                        <!-- Quiz Section -->
                        <div id="quiz-section" class="hidden mt-auto p-4 bg-blue-50 rounded-lg border-2 border-blue-200 transition-all duration-300">
                            <h3 id="quiz-question" class="text-base font-semibold text-blue-800 mb-3"></h3>
                            <div class="flex gap-2">
                                <input type="text" id="quiz-answer-input" placeholder="Type your answer..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none text-sm">
                                <button id="quiz-submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold text-sm flex-shrink-0">Submit</button>
                            </div>
                            <div id="quiz-feedback" class="mt-3 text-center font-semibold hidden text-sm"></div>
                        </div>
                        <button id="keep-exploring-btn" class="hidden mt-auto w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-md">Keep Exploring</button>
                    </div>
                </div>

                <div id="settings-panel" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 bg-gray-50 p-6 rounded-lg shadow-inner transition-colors duration-300">
                     <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <h3 class="setting-title text-lg font-semibold text-gray-700">Play Style</h3>
                            <svg data-setting="playStyle" xmlns="http://www.w3.org/2000/svg" class="info-icon h-5 w-5 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="play-style-options" class="setting-control flex p-1 rounded-lg">
                            <button data-value="explore" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm active">Explore</button>
                            <button data-value="timed" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Timed</button>
                            <button data-value="paced" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Paced</button>
                            <button data-value="sprint" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Sprint</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <h3 class="setting-title text-lg font-semibold text-gray-700">Tab Order</h3>
                            <svg data-setting="tabOrder" xmlns="http://www.w3.org/2000/svg" class="info-icon h-5 w-5 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="tab-order-options" class="setting-control flex p-1 rounded-lg">
                            <button data-value="random" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm active">Random</button>
                            <button data-value="alphabetical" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Alphabetical</button>
                            <button data-value="path" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Path</button>
                        </div>
                    </div>
                     <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <h3 class="setting-title text-lg font-semibold text-gray-700">Difficulty</h3>
                            <svg data-setting="difficulty" xmlns="http://www.w3.org/2000/svg" class="info-icon h-5 w-5 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="difficulty-options" class="setting-control flex p-1 rounded-lg">
                            <button data-value="easy" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Easy</button>
                            <button data-value="normal" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm active">Normal</button>
                            <button data-value="hard" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Hard</button>
                            <button data-value="extreme" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Extreme</button>
                            <button data-value="mirror" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Mirror</button>
                        </div>
                    </div>
                     <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <h3 class="setting-title text-lg font-semibold text-gray-700">Theme</h3>
                            <svg data-setting="theme" xmlns="http://www.w3.org/2000/svg" class="info-icon h-5 w-5 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="theme-options" class="setting-control flex p-1 rounded-lg">
                            <button data-value="voyager" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm active">Voyager</button>
                            <button data-value="midnight" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Midnight</button>
                            <button data-value="earth" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Earth</button>
                            <button data-value="oceanic" class="flex-1 text-center py-1.5 px-2 rounded-md font-medium text-sm">Oceanic</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                     <button id="finish-attempt-btn" class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed w-full md:w-auto">Finish & Score</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="fixed inset-0 bg-gray-100 p-4 sm:p-6 md:p-8 hidden overflow-y-auto">
        <div class="w-full max-w-7xl mx-auto">
            <header class="flex items-center justify-between mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-900">Your Profile</h1>
                <button id="close-profile-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-md">Back to Quiz</button>
            </header>

            <!-- Overall Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card p-4 rounded-lg text-center shadow">
                    <p class="text-sm text-gray-600">Games Played</p>
                    <p id="stat-games-played" class="text-3xl font-bold text-blue-800">0</p>
                </div>
                <div class="stat-card p-4 rounded-lg text-center shadow">
                    <p class="text-sm text-gray-600">Total Time Played</p>
                    <p id="stat-time-played" class="text-3xl font-bold text-blue-800">0m</p>
                </div>
                <div class="stat-card p-4 rounded-lg text-center shadow">
                    <p class="text-sm text-gray-600">Overall Accuracy</p>
                    <p id="stat-accuracy" class="text-3xl font-bold text-green-600">0%</p>
                </div>
                <div class="stat-card p-4 rounded-lg text-center shadow">
                    <p class="text-sm text-gray-600">Countries Explored</p>
                    <p id="stat-countries-explored" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
            </div>

            <!-- Best Scores -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Best Scores</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat-card p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg text-center text-blue-700">Timed</h3>
                        <p class="text-center text-2xl font-semibold" id="best-score-timed">0 / 0</p>
                        <p class="text-center text-sm text-gray-500" id="best-time-timed">Time: 0s</p>
                    </div>
                    <div class="stat-card p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg text-center text-blue-700">Paced</h3>
                        <p class="text-center text-2xl font-semibold" id="best-score-paced">0 / 0</p>
                    </div>
                    <div class="stat-card p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg text-center text-blue-700">Sprint</h3>
                        <p class="text-center text-2xl font-semibold" id="best-score-sprint">0</p>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Achievements</h2>
                <div id="achievements-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Achievements will be dynamically inserted here -->
                </div>
            </div>
             <div class="mt-8 text-center">
                <button id="reset-stats-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-md">Reset All Stats</button>
            </div>
        </div>
    </div>


    <!-- Modals -->
    <div id="score-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div id="score-modal-content" class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-4xl font-bold text-blue-900 mb-4" id="score-title">Your Score</h2>
            <p class="text-8xl font-bold text-green-500 mb-2" id="final-score"></p>
            <p class="text-2xl font-semibold text-gray-700 mb-2" id="final-total-score-display"></p>
            <p class="text-lg text-gray-500 mb-4" id="final-time-display"></p>
            <p class="text-lg text-gray-600 mb-6" id="score-details"></p>
            <div id="results-list" class="text-left max-h-60 overflow-y-auto mb-6 border border-gray-200 rounded-lg p-4">
                <h3 class="font-bold text-lg mb-2 text-red-700">Missed Answers:</h3>
                <div id="misses-container"></div>
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <button id="close-modal-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-md">Play Again</button>
                <button id="view-finished-map-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition shadow-md">View Finished Map</button>
                <a href="https://ko-fi.com/ohasa" target="_blank" rel="noopener noreferrer" class="inline-block bg-pink-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-pink-600 transition shadow-md">Like this quiz? Buy me a coffee!</a>
            </div>
        </div>
    </div>
    
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
        <div id="info-modal-content" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full text-left transform transition-all scale-95 opacity-100 relative">
            <button id="close-info-modal-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 id="info-modal-title" class="text-2xl font-bold text-gray-800 mb-4">Setting Info</h3>
            <div id="info-modal-body" class="text-gray-600 space-y-3"></div>
        </div>
    </div>

    <footer class="text-center py-4">
        <p class="text-gray-600 text-sm">
            Enjoying the quiz? 
            <a href="https://ko-fi.com/ohasa" target="_blank" rel="noopener noreferrer" class="font-semibold text-blue-600 hover:underline">
                Buy me a coffee!
            </a>
        </p>
    </footer>
    <script>
        // Inlined country data to avoid fetch error
        const countriesJsonData = {
          "canada": { "continent": "North America", "name": "Canada", "bio": "Canada has the longest coastline in the world, bordering three different oceans: the Atlantic, Pacific, and Arctic.", "quiz_question": "How many oceans does Canada's coastline border?", "quiz_answer": "Three", "biome": "forest", "biome_color": "#228b22" },
          "usa": { "continent": "North America", "name": "USA", "bio": "The United States is home to the world's largest economy and a diverse range of ecosystems, from deserts to lush forests.", "quiz_question": "What describes the range of ecosystems in the United States?", "quiz_answer": "diverse", "biome": "temperate", "biome_color": "#6b8e23" },
          "mexico": { "continent": "North America", "name": "Mexico", "bio": "Mexico is the birthplace of chocolate, originally cultivated by ancient Mesoamerican civilizations like the Mayans and Aztecs.", "quiz_question": "Which popular food item originated in Mexico?", "quiz_answer": "Chocolate", "biome": "temperate", "biome_color": "#6b8e23" },
          "bahamas": { "continent": "North America", "name": "Bahamas", "bio": "The Bahamas is an archipelago of over 700 islands and cays, famous for its stunning pink sand beaches.", "quiz_question": "What color are the famous sand beaches in the Bahamas?", "quiz_answer": "Pink", "biome": "temperate", "biome_color": "#6b8e23" },
          "cuba": { "continent": "North America", "name": "Cuba", "bio": "Cuba is renowned for its classic American cars from the 1950s, which are still a common sight on its roads.", "quiz_question": "What era of classic American cars are a common sight in Cuba?", "quiz_answer": "1950s", "biome": "temperate", "biome_color": "#6b8e23" },
          "jamaica": { "continent": "North America", "name": "Jamaica", "bio": "Jamaica is the birthplace of reggae music, a genre made famous worldwide by artists like Bob Marley.", "quiz_question": "Which genre of music originated in Jamaica?", "quiz_answer": "Reggae", "biome": "rainforest", "biome_color": "#2e8b57" },
          "haiti": { "continent": "North America", "name": "Haiti", "bio": "Haiti was the first independent nation of Latin America and the Caribbean, and the only nation in the world established as a result of a successful slave revolt.", "quiz_question": "What successful event established Haiti?", "quiz_answer": "A slave revolt", "biome": "temperate", "biome_color": "#6b8e23" },
          "dominicanrepublic": { "continent": "North America", "name": "Dominican Republic", "bio": "The Dominican Republic is the site of the first cathedral, castle, monastery, and fortress built in the Americas, located in its capital, Santo Domingo.", "quiz_question": "What is Dominican Republic's capital?", "quiz_answer": "Santo Domingo", "biome": "rainforest", "biome_color": "#2e8b57" },
          "belize": { "continent": "North America", "name": "Belize", "bio": "Belize is home to the second-largest barrier reef in the world, the Belize Barrier Reef, a haven for marine life.", "quiz_question": "What significant natural wonder is found off the coast of Belize?", "quiz_answer": "Belize Barrier Reef", "biome": "rainforest", "biome_color": "#2e8b57" },
          "guatemala": { "continent": "North America", "name": "Guatemala", "bio": "Guatemala is the heartland of the ancient Maya civilization, with many well-preserved ruins like Tikal.", "quiz_question": "Which ancient civilization's heartland was in Guatemala?", "quiz_answer": "The Maya", "biome": "rainforest", "biome_color": "#2e8b57" },
          "elsalvador": { "continent": "North America", "name": "El Salvador", "bio": "Known as the 'Land of Volcanoes,' El Salvador has more than 20 volcanoes, some of which are still active.", "quiz_question": "What nickname is given to El Salvador due to its geology?", "quiz_answer": "Land of Volcanoes", "biome": "temperate", "biome_color": "#6b8e23" },
          "honduras": { "continent": "North America", "name": "Honduras", "bio": "Honduras is known for the Lluvia de Peces, a phenomenon where fish reportedly fall from the sky during storms.", "quiz_question": "What strange weather phenomenon is Honduras known for?", "quiz_answer": "Lluvia de Peces", "biome": "rainforest", "biome_color": "#2e8b57" },
          "nicaragua": { "continent": "North America", "name": "Nicaragua", "bio": "Nicaragua is home to the only freshwater sharks in the world, found in Lake Nicaragua.", "quiz_question": "What unique animal is found in Lake Nicaragua?", "quiz_answer": "Freshwater sharks", "biome": "rainforest", "biome_color": "#2e8b57" },
          "costarica": { "continent": "North America", "name": "Costa Rica", "bio": "Costa Rica is a world leader in conservation and is one of the most biodiverse countries, with over 5% of the world's species.", "quiz_question": "What percentage of the world's species can be found in Costa Rica?", "quiz_answer": "Over 5%", "biome": "rainforest", "biome_color": "#2e8b57" },
          "panama": { "continent": "North America", "name": "Panama", "bio": "Panama is famous for the Panama Canal, an artificial waterway that connects the Atlantic and Pacific oceans, revolutionizing international trade.", "quiz_question": "What man-made marvel is Panama famous for?", "quiz_answer": "Panama Canal", "biome": "rainforest", "biome_color": "#2e8b57" },
          "colombia": { "continent": "South America", "name": "Colombia", "bio": "Colombia is the world's leading producer of high-quality emeralds and is known for its vibrant coffee culture.", "quiz_question": "What precious gemstone is Colombia the leading producer of?", "quiz_answer": "Emeralds", "biome": "rainforest", "biome_color": "#2e8b57" },
          "venezuela": { "continent": "South America", "name": "Venezuela", "bio": "Venezuela is home to Angel Falls, the world's tallest uninterrupted waterfall.", "quiz_question": "What is the tallest uninterrupted waterfall?", "quiz_answer": "Angel Falls", "biome": "rainforest", "biome_color": "#2e8b57" },
          "trinidad": { "continent": "South America", "name": "Trinidad and Tobago", "bio": "Trinidad and Tobago is the birthplace of the steelpan, the only acoustic musical instrument invented in the 20th century.", "quiz_question": "What unique musical instrument was invented in Trinidad and Tobago?", "quiz_answer": "Steelpan", "biome": "rainforest", "biome_color": "#2e8b57" },
          "guyana": { "continent": "South America", "name": "Guyana", "bio": "Guyana is the only English-speaking country in South America and is largely covered by pristine rainforest.", "quiz_question": "What language makes Guyana unique among South American countries?", "quiz_answer": "English", "biome": "rainforest", "biome_color": "#2e8b57" },
          "suriname": { "continent": "South America", "name": "Suriname", "bio": "Suriname is the most forested country on Earth, with about 93% of its land area covered by forests.", "quiz_question": "What covers 93% of Suriname's land?", "quiz_answer": "Forest", "biome": "rainforest", "biome_color": "#2e8b57" },
          "france": { "continent": "Europe", "name": "France", "bio": "France is the most visited country in the world, famous for its gastronomy, art museums like the Louvre, and iconic landmarks.", "quiz_question": "What is France famous for?", "quiz_answer": "Gastronomy", "biome": "temperate", "biome_color": "#6b8e23" },
          "ecuador": { "continent": "South America", "name": "Ecuador", "bio": "Ecuador is named after the equator, which runs through the country, and it owns the famous Galápagos Islands.", "quiz_question": "What geographical line is Ecuador named after?", "quiz_answer": "the Equator", "biome": "rainforest", "biome_color": "#2e8b57" },
          "peru": { "continent": "South America", "name": "Peru", "bio": "Peru was the heart of the Inca Empire and is home to the stunning ancient citadel of Machu Picchu.", "quiz_question": "What famous ancient citadel is located in Peru?", "quiz_answer": "Machu Picchu", "biome": "rainforest", "biome_color": "#2e8b57" },
          "bolivia": { "continent": "South America", "name": "Bolivia", "bio": "Bolivia is home to Salar de Uyuni, the world's largest salt flat, which creates a stunning mirror effect during the rainy season.", "quiz_question": "What is the name of the world's largest salt flat in Bolivia?", "quiz_answer": "Salar de Uyuni", "biome": "rainforest", "biome_color": "#2e8b57" },
          "brazil": { "continent": "South America", "name": "Brazil", "bio": "Brazil is the largest country in South America and is home to the majority of the Amazon Rainforest, the world's largest tropical rainforest.", "quiz_question": "Which massive rainforest is largely contained within Brazil?", "quiz_answer": "Amazon Rainforest", "biome": "rainforest", "biome_color": "#2e8b57" },
          "paraguay": { "continent": "South America", "name": "Paraguay", "bio": "Paraguay is a landlocked country known for its large hydroelectric dams, particularly the Itaipu Dam, one of the largest in the world.", "quiz_question": "What major source of energy is Paraguay known for?", "quiz_answer": "Large hydroelectric dams", "biome": "temperate", "biome_color": "#6b8e23" },
          "uruguay": { "continent": "South America", "name": "Uruguay", "bio": "Uruguay was the host and winner of the very first FIFA World Cup in 1930.", "quiz_question": "When was the first FIFA World Cup?", "quiz_answer": "1930", "biome": "temperate", "biome_color": "#6b8e23" },
          "argentina": { "continent": "South America", "name": "Argentina", "bio": "Argentina is the birthplace of the tango, a passionate and dramatic dance, and is famous for its high-quality beef.", "quiz_question": "Which famous dance originated in Argentina?", "quiz_answer": "The tango", "biome": "temperate", "biome_color": "#6b8e23" },
          "chile": { "continent": "South America", "name": "Chile", "bio": "Chile is a long, narrow country that is home to the Atacama Desert, one of the driest places on Earth.", "quiz_question": "What is the name of the extremely dry desert located in Chile?", "quiz_answer": "The Atacama Desert", "biome": "temperate", "biome_color": "#6b8e23" },
          "falklandislands": { "continent": "South America", "name": "Falkland Islands", "bio": "The Falkland Islands are a remote South Atlantic archipelago, renowned for their abundant wildlife, including several species of penguins.", "quiz_question": "What type of bird is famously abundant on the Falkland Islands?", "quiz_answer": "Penguins", "biome": "tundra", "biome_color": "#add8e6" },
          "iceland": { "continent": "Europe", "name": "Iceland", "bio": "Known as the 'Land of Fire and Ice,' Iceland features a stunning landscape of volcanoes, geysers, hot springs, and glaciers.", "quiz_question": "What nickname reflects Iceland's dramatic landscape?", "quiz_answer": "The Land of Fire and Ice", "biome": "tundra", "biome_color": "#add8e6" },
          "ireland": { "continent": "Europe", "name": "Ireland", "bio": "Ireland, the 'Emerald Isle,' is famous for its lush green landscapes, ancient castles, and the tradition of Halloween, which originated from the Celtic festival of Samhain.", "quiz_question": "What modern holiday has its roots in an ancient Irish festival?", "quiz_answer": "Halloween", "biome": "temperate", "biome_color": "#6b8e23" },
          "uk": { "continent": "Europe", "name": "United Kingdom", "bio": "The United Kingdom is a union of four countries and is home to the world's oldest underground railway, the London Underground.", "quiz_question": "What is the nickname for the world's oldest underground railway in London?", "quiz_answer": "The Tube", "biome": "temperate", "biome_color": "#6b8e23" },
          "norway": { "continent": "Europe", "name": "Norway", "bio": "Norway is famous for its deep coastal fjords, which were carved by glaciers during the Ice Age.", "quiz_question": "What are the famous, deep coastal inlets in Norway called?", "quiz_answer": "Fjords", "biome": "forest", "biome_color": "#228b22" },
          "sweden": { "continent": "Europe", "name": "Sweden", "bio": "Sweden is known for its Allemansratten, allowing people to freely hike and camp almost anywhere in the countryside.", "quiz_question": "What is the Swedish policy that allows public access to nature called?", "quiz_answer": "Allemansratten", "biome": "forest", "biome_color": "#228b22" },
          "finland": { "continent": "Europe", "name": "Finland", "bio": "Finland is known as the 'Land of a Thousand Lakes' and is famous for its saunas, an integral part of the national culture.", "quiz_question": "Besides lakes, what cultural institution is Finland famous for?", "quiz_answer": "Saunas", "biome": "forest", "biome_color": "#228b22" },
          "estonia": { "continent": "Europe", "name": "Estonia", "bio": "Estonia is one of the world's most digitally advanced societies, where citizens can vote and access government services online.", "quiz_question": "Where can Estonian government services be found?", "quiz_answer": "online", "biome": "temperate", "biome_color": "#6b8e23" },
          "latvia": { "continent": "Europe", "name": "Latvia", "bio": "Latvia has one of the fastest internet speeds in the world and is known for its vast forests and beautiful Art Nouveau architecture in its capital, Riga.", "quiz_question": "What architectural style is prominent in Latvia's capital, Riga?", "quiz_answer": "Art Nouveau", "biome": "temperate", "biome_color": "#6b8e23" },
          "lithuania": { "continent": "Europe", "name": "Lithuania", "bio": "Lithuania is famous for its amber, often called 'Baltic gold,' which has been harvested from its coast for centuries.", "quiz_question": "What natural gem is Lithuania famous for?", "quiz_answer": "Amber", "biome": "temperate", "biome_color": "#6b8e23" },
          "russia": { "continent": "Europe/Asia", "name": "Russia", "bio": "Russia is the largest country in the world by land area, spanning eleven time zones and a vast range of environments.", "quiz_question": "How many time zones does Russia span?", "quiz_answer": "Eleven", "biome": "forest", "biome_color": "#228b22" },
          "belarus": { "continent": "Europe", "name": "Belarus", "bio": "Belarus is home to the Białowieża Forest, one of the last and largest remaining parts of the immense primeval forest that once stretched across Europe.", "quiz_question": "What is the name of the ancient primeval forest in Belarus?", "quiz_answer": "Bialowieza Forest", "biome": "temperate", "biome_color": "#6b8e23" },
          "ukraine": { "continent": "Europe", "name": "Ukraine", "bio": "Ukraine is known as the 'breadbasket of Europe' due to its vast, fertile plains that produce large quantities of grain.", "quiz_question": "What nickname has Ukraine earned due to its agricultural output?", "quiz_answer": "The breadbasket of Europe", "biome": "temperate", "biome_color": "#6b8e23" },
          "moldova": { "continent": "Europe", "name": "Moldova", "bio": "Moldova is famous for its wine industry and is home to Mileștii Mici, which holds the Guinness World Record for the largest wine cellar in the world.", "quiz_question": "Where is the largest wine cellar in the world?", "quiz_answer": "Milestii Mici", "biome": "temperate", "biome_color": "#6b8e23" },
          "romania": { "continent": "Europe", "name": "Romania", "bio": "Romania is home to the region of Transylvania, famously associated with the legend of Dracula and dotted with medieval towns and castles.", "quiz_question": "Which legendary figure is associated with Romania's Transylvania region?", "quiz_answer": "Dracula", "biome": "temperate", "biome_color": "#6b8e23" },
          "bulgaria": { "continent": "Europe", "name": "Bulgaria", "bio": "Bulgaria is one of the world's largest producers of rose oil, an essential ingredient in many perfumes, harvested from the 'Rose Valley'.", "quiz_question": "What fragrant product is Bulgaria a top producer of?", "quiz_answer": "Rose oil", "biome": "temperate", "biome_color": "#6b8e23" },
          "cyprus": { "continent": "Europe/Asia", "name": "Cyprus", "bio": "Cyprus is an island nation where, according to mythology, the goddess Aphrodite was born from the sea foam.", "quiz_question": "Which Greek goddess is said to have been born in Cyprus?", "quiz_answer": "Aphrodite", "biome": "temperate", "biome_color": "#6b8e23" },
          "greece": { "continent": "Europe", "name": "Greece", "bio": "Greece is the cradle of Western civilization, credited with the birth of democracy, philosophy, and the Olympic Games.", "quiz_question": "What major global sporting event originated in ancient Greece?", "quiz_answer": "The Olympic Games", "biome": "temperate", "biome_color": "#6b8e23" },
          "macedonia": { "continent": "Europe", "name": "North Macedonia", "bio": "North Macedonia is home to Lake Ohrid, one of the oldest and deepest lakes in Europe, preserving a unique aquatic ecosystem.", "quiz_question": "What lake in North Macedonia has a unique aquatic ecosystem?", "quiz_answer": "Lake Orchid", "biome": "temperate", "biome_color": "#6b8e23" },
          "albania": { "continent": "Europe", "name": "Albania", "bio": "Albania has a unique tradition of building thousands of concrete bunkers across the country, a remnant of its isolationist past.", "quiz_question": "What unusual structures are found all over Albania?", "quiz_answer": "Concrete bunkers", "biome": "temperate", "biome_color": "#6b8e23" },
          "serbia": { "continent": "Europe", "name": "Serbia", "bio": "Serbia is one of the world's largest exporters of raspberries, and the word 'vampire' is one of the few Serbian words widely used globally.", "quiz_question": "What common supernatural term is originally a Serbian word?", "quiz_answer": "Vampire", "biome": "temperate", "biome_color": "#6b8e23" },
          "kosovo": { "continent": "Europe", "name": "Kosovo", "bio": "Kosovo is Europe's newest country, having declared independence in 2008, and has one of the youngest populations on the continent.", "quiz_question": "When did Kosovo declare independence?", "quiz_answer": "2008", "biome": "temperate", "biome_color": "#6b8e23" },
          "montenegro": { "continent": "Europe", "name": "Montenegro", "bio": "Montenegro is home to the Bay of Kotor, often called Europe's southernmost fjord, known for its dramatic, mountainous coastline.", "quiz_question": "What is the famous, fjord-like bay in Montenegro called?", "quiz_answer": "The Bay of Kotor", "biome": "temperate", "biome_color": "#6b8e23" },
          "bosnia": { "continent": "Europe", "name": "Bosnia and Herzegovina", "bio": "Bosnia and Herzegovina is often called the 'Heart-Shaped Land' due to its distinctive shape on a map.", "quiz_question": "What shape is Bosnia and Herzegovina on a map?", "quiz_answer": "Heart", "biome": "temperate", "biome_color": "#6b8e23" },
          "croatia": { "continent": "Europe", "name": "Croatia", "bio": "Croatia is famous for its stunning Adriatic coastline with over a thousand islands, and it is the birthplace of the necktie.", "quiz_question": "What common piece of menswear originated in Croatia?", "quiz_answer": "Necktie", "biome": "temperate", "biome_color": "#6b8e23" },
          "slovenia": { "continent": "Europe", "name": "Slovenia", "bio": "Slovenia is a country of caves, with over 10,000 registered caves, including the famous Postojna Cave.", "quiz_question": "What geological feature is extremely common in Slovenia?", "quiz_answer": "Caves", "biome": "temperate", "biome_color": "#6b8e23" },
          "hungary": { "continent": "Europe", "name": "Hungary", "bio": "Hungary's capital, Budapest, has more thermal water springs than any other capital city in the world, earning it the nickname 'City of Spas'.", "quiz_question": "What is Budapest's nickname?", "quiz_answer": "City of Spas", "biome": "temperate", "biome_color": "#6b8e23" },
          "slovakia": { "continent": "Europe", "name": "Slovakia", "bio": "Slovakia has the highest number of castles and chateaux per capita in the world.", "quiz_question": "What is the plural of chateau?", "quiz_answer": "chateaux.", "biome": "temperate", "biome_color": "#6b8e23" },
          "czechia": { "continent": "Europe", "name": "Czechia", "bio": "Czechia, also known as the Czech Republic, has the highest beer consumption per capita in the world and is the original home of the Pilsner lager.", "quiz_question": "What beverage is famously consumed in large quantities in Czechia?", "quiz_answer": "Beer", "biome": "temperate", "biome_color": "#6b8e23" },
          "poland": { "continent": "Europe", "name": "Poland", "bio": "Poland has its roots in music history, being the birthplace of composer Frédéric Chopin.", "quiz_question": "Which famous composer was born in Poland?", "quiz_answer": "Chopin", "biome": "temperate", "biome_color": "#6b8e23" },
          "germany": { "continent": "Europe", "name": "Germany", "bio": "Germany is famous for its automotive industry, with brands like Volkswagen, BMW, and Mercedes-Benz, and for its tradition of Oktoberfest.", "quiz_question": "What famous annual festival in Germany celebrates beer and Bavarian culture?", "quiz_answer": "Oktoberfest", "biome": "temperate", "biome_color": "#6b8e23" },
          "denmark": { "continent": "Europe", "name": "Denmark", "bio": "Denmark is the home of LEGO bricks and is consistently ranked as one of the happiest countries in the world.", "quiz_question": "What world-famous toy originated in Denmark?", "quiz_answer": "LEGO", "biome": "temperate", "biome_color": "#6b8e23" },
          "netherlands": { "continent": "Europe", "name": "Netherlands", "bio": "The Netherlands is famous for its windmills, tulips, and extensive system of canals. A significant portion of the country lies below sea level, protected by dikes.", "quiz_question": "What structures protect the low-lying areas of the Netherlands from flooding?", "quiz_answer": "Dikes", "biome": "temperate", "biome_color": "#6b8e23" },
          "belgium": { "continent": "Europe", "name": "Belgium", "bio": "Belgium is world-renowned for its high-quality chocolate, waffles, and a vast variety of beers.", "quiz_question": "Besides chocolate, what other sweet treat is Belgium famous for?", "quiz_answer": "Waffles", "biome": "temperate", "biome_color": "#6b8e23" },
          "luxembourg": { "continent": "Europe", "name": "Luxembourg", "bio": "Luxembourg is one of the smallest and wealthiest countries in the world, and it was the world's first country to offer free public transport for everyone.", "quiz_question": "What is the cost of public transport in Luxembourg?", "quiz_answer": "Free", "biome": "temperate", "biome_color": "#6b8e23" },
          "switzerland": { "continent": "Europe", "name": "Switzerland", "bio": "Switzerland is famous for its policy of armed neutrality, its stunning Alpine scenery, and its high-quality watches and chocolate.", "quiz_question": "What long-standing foreign policy is Switzerland known for?", "quiz_answer": "Armed neutrality", "biome": "temperate", "biome_color": "#6b8e23" },
          "lichtenstein": { "continent": "Europe", "name": "Liechtenstein", "bio": "Liechtenstein is one of only two 'doubly landlocked' countries in the world, meaning it is a landlocked country surrounded by other landlocked countries.", "quiz_question": "How many doubly landlocked countries are there?", "quiz_answer": "Two", "biome": "temperate", "biome_color": "#6b8e23" },
          "austria": { "continent": "Europe", "name": "Austria", "bio": "Austria is renowned for its rich musical heritage, being the home of classical composers like Mozart, and for its breathtaking Alpine landscapes.", "quiz_question": "Which famous classical composer was from Austria?", "quiz_answer": "Mozart", "biome": "temperate", "biome_color": "#6b8e23" },
          "italy": { "continent": "Europe", "name": "Italy", "bio": "Italy is the heart of the ancient Roman Empire and the Renaissance, and it has more UNESCO World Heritage sites than any other country.", "quiz_question": "What ancient power was located in Italy?", "quiz_answer": "Roman Empire", "biome": "temperate", "biome_color": "#6b8e23" },
          "spain": { "continent": "Europe", "name": "Spain", "bio": "Spain is known for its vibrant flamenco music and dance, late-night dinners, and unique architectural works by Antoni Gaudí.", "quiz_question": "What is the famous style of music and dance from the Andalusia region of Spain?", "quiz_answer": "Flamenco", "biome": "temperate", "biome_color": "#6b8e23" },
          "portugal": { "continent": "Europe", "name": "Portugal", "bio": "Portugal is one of the oldest nations in Europe and is famous for its Age of Discovery, Port wine, and decorative ceramic tiles known as azulejos.", "quiz_question": "What are the decorative ceramic tiles famous in Portugal called?", "quiz_answer": "Azulejos.", "biome": "temperate", "biome_color": "#6b8e23" },
          "morocco": { "continent": "Africa", "name": "Morocco", "bio": "Morocco is known for its bustling souks (marketplaces), vibrant tilework, and the production of argan oil, a rare oil used in cosmetics and cuisine.", "quiz_question": "What are Morrocan marketplaces called?", "quiz_answer": "souks", "biome": "desert", "biome_color": "#f4a460" },
          "algeria": { "continent": "Africa", "name": "Algeria", "bio": "Algeria is the largest country in Africa, and over 80% of its land is covered by the Sahara Desert.", "quiz_question": "What desert covers most of Algeria?", "quiz_answer": "Sahara", "biome": "desert", "biome_color": "#f4a460" },
          "tunisia": { "continent": "Africa", "name": "Tunisia", "bio": "Tunisia is home to the ruins of the ancient city of Carthage, a powerful trading empire that once rivaled Rome.", "quiz_question": "What ancient rival of Rome was located in modern-day Tunisia?", "quiz_answer": "Carthage.", "biome": "desert", "biome_color": "#f4a460" },
          "libya": { "continent": "Africa", "name": "Libya", "bio": "Libya's territory is almost entirely desert, and it holds some of the best-preserved Roman ruins in the world, such as Leptis Magna.", "quiz_question": "What ancient ruins are preserved in Libya?", "quiz_answer": "Leptis Magna", "biome": "desert", "biome_color": "#f4a460" },
          "egypt": { "continent": "Africa", "name": "Egypt", "bio": "Egypt is home to one of the world's earliest and greatest civilizations, famous for its pyramids, pharaohs, and the Nile River.", "quiz_question": "There is a river in Egypt...", "quiz_answer": "The Nile", "biome": "desert", "biome_color": "#f4a460" },
          "mauritania": { "continent": "Africa", "name": "Mauritania", "bio": "Mauritania is home to the Richat Structure, also known as the 'Eye of the Sahara,' a massive and mysterious circular geological formation.", "quiz_question": "What mysterious structure has its home in Mauritania?", "quiz_answer": "Richat Structure", "biome": "desert", "biome_color": "#f4a460" },
          "mali": { "continent": "Africa", "name": "Mali", "bio": "Mali was once the center of wealthy West African empires, and the city of Timbuktu was a major center of learning and trade.", "quiz_question": "What ancient city in Mali was a famous center of learning?", "quiz_answer": "Timbuktu.", "biome": "desert", "biome_color": "#f4a460" },
          "burkinafaso": { "continent": "Africa", "name": "Burkina Faso", "bio": "Burkina Faso is the host of the largest craft market in Africa, the SIAO, held in Ouagadougou", "quiz_question": "Where does Burkina Faso host the SIAO?", "quiz_answer": "Ouagadougou", "biome": "savanna", "biome_color": "#c3b091" },
          "niger": { "continent": "Africa", "name": "Niger", "bio": "Niger is named after the Niger River and is home to the last wild herds of West African giraffes.", "quiz_question": "What unique and endangered animal can be found in Niger?", "quiz_answer": "West African giraffes.", "biome": "desert", "biome_color": "#f4a460" },
          "chad": { "continent": "Africa", "name": "Chad", "bio": "Chad is known as the 'Babel Tower of the World' because of the large number of languages and ethnic groups within its borders.", "quiz_question": "What is Chad's nickname?", "quiz_answer": "Babel Tower of the World", "biome": "desert", "biome_color": "#f4a460" },
          "sudan": { "continent": "Africa", "name": "Sudan", "bio": "Sudan has more pyramids than Egypt, built by the ancient Kushite kingdom, though they are smaller and steeper.", "quiz_question": "Which country has more pyramids: Sudan or Egypt?", "quiz_answer": "Sudan.", "biome": "desert", "biome_color": "#f4a460" },
          "eritrea": { "continent": "Africa", "name": "Eritrea", "bio": "Eritrea's capital, Asmara, is a UNESCO World Heritage site for its well-preserved modernist architecture from the Italian colonial era.", "quiz_question": "What is the capital city of Eritrea?", "quiz_answer": "Asmara", "biome": "desert", "biome_color": "#f4a460" },
          "djibouti": { "continent": "Africa", "name": "Djibouti", "bio": "Djibouti is home to Lake Assal, which is the lowest point in Africa and one of the saltiest bodies of water in the world.", "quiz_question": "What is the lowest point in Africa?", "quiz_answer": "Lake Assal", "biome": "desert", "biome_color": "#f4a460" },
          "senegal": { "continent": "Africa", "name": "Senegal", "bio": "Senegal is known for its tradition of 'Teranga' (hospitality) and is home to the massive African Renaissance Monument.", "quiz_question": "What is the Senegalese concept of hospitality called?", "quiz_answer": "Teranga", "biome": "savanna", "biome_color": "#c3b091" },
          "gambia": { "continent": "Africa", "name": "Gambia", "bio": "The Gambia is the smallest country on mainland Africa and is almost entirely surrounded by Senegal.", "quiz_question": "What country surrounds most of Gambia?", "quiz_answer": "Senegal", "biome": "savanna", "biome_color": "#c3b091" },
          "guineabissau": { "continent": "Africa", "name": "Guinea-Bissau", "bio": "Guinea-Bissau is known for the Bijagós Archipelago, a group of islands that is a UNESCO Biosphere Reserve with a matriarchal society.", "quiz_question": "What is the name of the UNESCO biosphere in Guinea-Bissau?", "quiz_answer": "Bijagos Archipelago", "biome": "savanna", "biome_color": "#c3b091" },
          "guinea": { "continent": "Africa", "name": "Guinea", "bio": "Guinea holds the world's largest reserves of bauxite, the main source of aluminum.", "quiz_question": "What important natural resource does Guinea have in abundance?", "quiz_answer": "Bauxite", "biome": "rainforest", "biome_color": "#2e8b57" },
          "sierraleone": { "continent": "Africa", "name": "Sierra Leone", "bio": "Sierra Leone is one of the world's top producers of diamonds, though its history with them is complex.", "quiz_question": "What precious stone is Sierra Leone known for producing?", "quiz_answer": "Diamonds", "biome": "rainforest", "biome_color": "#2e8b57" },
          "liberia": { "continent": "Africa", "name": "Liberia", "bio": "Liberia is Africa's oldest republic and was founded by freed American slaves.", "quiz_question": "Who founded the nation of Liberia?", "quiz_answer": "Freed American slaves", "biome": "rainforest", "biome_color": "#2e8b57" },
          "ivorycoast": { "continent": "Africa", "name": "Ivory Coast", "bio": "Côte d'Ivoire (Ivory Coast) is the world's largest producer of cocoa beans, the main ingredient for chocolate.", "quiz_question": "What food ingredient is the Ivory Coast the world's top producer of?", "quiz_answer": "Cocoa beans", "biome": "rainforest", "biome_color": "#2e8b57" },
          "ghana": { "continent": "Africa", "name": "Ghana", "bio": "Ghana was the first sub-Saharan African country to gain independence from colonial rule and is a major producer of gold and cocoa.", "quiz_question": "What status was Ghana the first sub-Saharan country to gain?", "quiz_answer": "Independence", "biome": "rainforest", "biome_color": "#2e8b57" },
          "togo": { "continent": "Africa", "name": "Togo", "bio": "Togo is one of the world's largest producers of phosphates, a key ingredient in fertilizers.", "quiz_question": "What important mineral is Togo a leading producer of?", "quiz_answer": "Phosphates.", "biome": "savanna", "biome_color": "#c3b091" },
          "benin": { "continent": "Africa", "name": "Benin", "bio": "Benin is considered the birthplace of the Vodun (Voodoo) religion, which is practiced by a significant portion of the population.", "quiz_question": "What major religion has its origins in Benin?", "quiz_answer": "Voodoo", "biome": "savanna", "biome_color": "#c3b091" },
          "nigeria": { "continent": "Africa", "name": "Nigeria", "bio": "Nigeria is the most populous country in Africa and is known for its booming film industry, nicknamed 'Nollywood'.", "quiz_question": "What is the nickname for Nigeria's film industry?", "quiz_answer": "Nollywood", "biome": "rainforest", "biome_color": "#2e8b57" },
          "cameroon": { "continent": "Africa", "name": "Cameroon", "bio": "Cameroon is often called 'Africa in miniature' due to its immense geological and cultural diversity, encompassing beaches, deserts, mountains, rainforests, and savannas.", "quiz_question": "What is Cameroon's nickname?", "quiz_answer": "Africa in Miniature", "biome": "rainforest", "biome_color": "#2e8b57" },
          "centralafricanrepublic": { "continent": "Africa", "name": "Central African Republic", "bio": "The Central African Republic is one of the most biodiverse areas in Africa, home to forest elephants and lowland gorillas.", "quiz_question": "What elephants can be found in the Central African Republic?", "quiz_answer": "Forest elephants", "biome": "rainforest", "biome_color": "#2e8b57" },
          "southsudan": { "continent": "Africa", "name": "South Sudan", "bio": "South Sudan is the world's newest sovereign state, having gained independence in 2011, and is home to vast and largely untouched savanna and wetland ecosystems.", "quiz_question": "When did South Sudan gain its independence?", "quiz_answer": "2011", "biome": "savanna", "biome_color": "#c3b091" },
          "ethiopia": { "continent": "Africa", "name": "Ethiopia", "bio": "Ethiopia is the birthplace of coffee and is the only African country that was never formally colonized.", "quiz_question": "What popular beverage originated in Ethiopia?", "quiz_answer": "Coffee", "biome": "savanna", "biome_color": "#c3b091" },
          "somalia": { "continent": "Africa", "name": "Somalia", "bio": "Somalia has the longest coastline on mainland Africa and has a long history as an important center for commerce with the rest of the ancient world.", "quiz_question": "What geographic feature does Somalia have that is the longest on mainland Africa?", "quiz_answer": "Coastline", "biome": "desert", "biome_color": "#f4a460" },
          "equatorialguinea": { "continent": "Africa", "name": "Equatorial Guinea", "bio": "Equatorial Guinea is the only sovereign African state where Spanish is an official language.", "quiz_question": "What hispanic language is unique to Equatorial Guinea?", "quiz_answer": "Spanish", "biome": "rainforest", "biome_color": "#2e8b57" },
          "gabon": { "continent": "Africa", "name": "Gabon", "bio": "Gabon is a major protector of rainforests, with over 10% of its land dedicated to national parks, providing a sanctuary for a large population of forest elephants.", "quiz_question": "What percentage of land in Gabon is dedicated to national parks?", "quiz_answer": "10%", "biome": "rainforest", "biome_color": "#2e8b57" },
          "republicofthecongo": { "continent": "Africa", "name": "Republic of the Congo", "bio": "The Republic of the Congo is home to a significant portion of the Congo Basin, the second-largest rainforest in the world.", "quiz_question": "What major rainforest is located in the Republic of the Congo?", "quiz_answer": "The Congo Basin", "biome": "rainforest", "biome_color": "#2e8b57" },
          "democraticrepublicofthecongo": { "continent": "Africa", "name": "Democratic Republic of the Congo", "bio": "The Democratic Republic of the Congo is the world's largest producer of cobalt, a critical component in lithium-ion batteries.", "quiz_question": "What essential industrial metal is the DRC the world's largest producer of?", "quiz_answer": "Cobalt", "biome": "rainforest", "biome_color": "#2e8b57" },
          "rwanda": { "continent": "Africa", "name": "Rwanda", "bio": "Known as the 'Land of a Thousand Hills,' Rwanda is famous for its mountain gorillas, which tourists can visit in Volcanoes National Park.", "quiz_question": "What endangered primate is Rwanda famous for protecting?", "quiz_answer": "Mountain gorillas", "biome": "savanna", "biome_color": "#c3b091" },
          "burundi": { "continent": "Africa", "name": "Burundi", "bio": "Burundi is known for its drummers, whose traditional drumming has been recognized by UNESCO as a masterpiece of intangible cultural heritage.", "quiz_question": "What traditional performance from Burundi is recognized by UNESCO?", "quiz_answer": "drumming", "biome": "savanna", "biome_color": "#c3b091" },
          "brunei": { "continent": "Asia", "name": "Brunei", "bio": "Brunei is a tiny, oil-rich sultanate on the island of Borneo, known for its opulent mosques and biodiverse rainforests.", "quiz_question": "What natural resource is the source of Brunei's wealth?", "quiz_answer": "Oil", "biome": "rainforest", "biome_color": "#2e8b57" },
          "bhutan": { "continent": "Asia", "name": "Bhutan", "bio": "Bhutan is the only country in the world that measures its success by Gross National Happiness instead of Gross Domestic Product.", "quiz_question": "What unique metric does Bhutan use to measure its success?", "quiz_answer": "Gross National Happiness", "biome": "temperate", "biome_color": "#6b8e23" },
          "uganda": { "continent": "Africa", "name": "Uganda", "bio": "Uganda is known as the 'Pearl of Africa' and is home to the source of the Nile River at Lake Victoria.", "quiz_question": "What major river has its source in Uganda?", "quiz_answer": "The Nile River", "biome": "savanna", "biome_color": "#c3b091" },
          "kenya": { "continent": "Africa", "name": "Kenya", "bio": "Kenya is famous for its vast savanna grasslands and the Great Migration, where millions of wildebeest and other animals cross the Maasai Mara.", "quiz_question": "What is the famous annual animal migration in Kenya called?", "quiz_answer": "The Great Migration", "biome": "savanna", "biome_color": "#c3b091" },
          "tanzania": { "continent": "Africa", "name": "Tanzania", "bio": "Tanzania is home to Africa's highest peak, Mount Kilimanjaro, and the vast Serengeti National Park.", "quiz_question": "What is the name of Africa's highest mountain, located in Tanzania?", "quiz_answer": "Mount Kilimanjaro", "biome": "savanna", "biome_color": "#c3b091" },
          "angola": { "continent": "Africa", "name": "Angola", "bio": "Angola is a major oil and diamond producer in Africa, and its music genre, Kizomba, has gained international popularity.", "quiz_question": "What popular music and dance genre originated in Angola?", "quiz_answer": "Kizomba", "biome": "savanna", "biome_color": "#c3b091" },
          "zambia": { "continent": "Africa", "name": "Zambia", "bio": "Zambia is home to the Victoria Falls, one of the largest and most spectacular waterfalls in the world, which it shares with Zimbabwe.", "quiz_question": "What massive waterfall does Zambia share with Zimbabwe?", "quiz_answer": "Victoria Falls", "biome": "savanna", "biome_color": "#c3b091" },
          "malawi": { "continent": "Africa", "name": "Malawi", "bio": "Malawi is dominated by Lake Malawi, one of the largest lakes in the world, which contains more species of fish than any other lake on Earth.", "quiz_question": "What lake has the most species of fish on Earth?", "quiz_answer": "Lake Malawi", "biome": "savanna", "biome_color": "#c3b091" },
          "mozambique": { "continent": "Africa", "name": "Mozambique", "bio": "Mozambique has a long, beautiful coastline on the Indian Ocean, known for its pristine beaches and well-preserved coral reefs.", "quiz_question": "What ocean borders Mozambique's coastline?", "quiz_answer": "Indian Ocean", "biome": "savanna", "biome_color": "#c3b091" },
          "zimbabwe": { "continent": "Africa", "name": "Zimbabwe", "bio": "Zimbabwe is named after the Great Zimbabwe, a medieval stone city that was the capital of a vast empire.", "quiz_question": "What ancient stone city is Zimbabwe named after?", "quiz_answer": "Great Zimbabwe", "biome": "savanna", "biome_color": "#c3b091" },
          "botswana": { "continent": "Africa", "name": "Botswana", "bio": "Botswana is known for its stable democracy and the Okavango Delta, a vast inland river delta that floods seasonally, creating a lush animal habitat.", "quiz_question": "What is the name of the unique inland delta in Botswana?", "quiz_answer": "The Okavango Delta", "biome": "desert", "biome_color": "#f4a460" },
          "namibia": { "continent": "Africa", "name": "Namibia", "bio": "Namibia is home to the Namib Desert, one of the oldest and driest deserts in the world, featuring some of the highest sand dunes.", "quiz_question": "What is the name of the ancient desert that covers much of Namibia?", "quiz_answer": "The Namib Desert", "biome": "desert", "biome_color": "#f4a460" },
          "southafrica": { "continent": "Africa", "name": "South Africa", "bio": "South Africa is known as the 'Rainbow Nation' for its multicultural diversity and has three capital cities: Pretoria, Cape Town, and Bloemfontein.", "quiz_question": "How many capital cities does South Africa have?", "quiz_answer": "Thre", "biome": "temperate", "biome_color": "#6b8e23" },
          "lesotho": { "continent": "Africa", "name": "Lesotho", "bio": "Lesotho is a high-altitude, landlocked kingdom entirely surrounded by South Africa, and it is the only independent state in the world that lies entirely above 1,000 meters.", "quiz_question": "What elevation does Lesotho lie above?", "quiz_answer": "1,000 meters", "biome": "temperate", "biome_color": "#6b8e23" },
          "eswatini": { "continent": "Africa", "name": "Eswatini", "bio": "Eswatini, formerly known as Swaziland, is one of the last absolute monarchies in the world and is known for its vibrant traditional culture.", "quiz_question": "What system of government does Eswatini have?", "quiz_answer": "An absolute monarchy.", "biome": "savanna", "biome_color": "#c3b091" },
          "madagascar": { "continent": "Africa", "name": "Madagascar", "bio": "Madagascar is the world's fourth-largest island and is famous for its unique wildlife, with over 90% of its species are endemic.", "quiz_question": "What are 90% of species in Madagascar?", "quiz_answer": "Endemic", "biome": "rainforest", "biome_color": "#2e8b57" },
          "japan": { "continent": "Asia", "name": "Japan", "bio": "Japan is an archipelago known for its blend of ancient traditions and futuristic technology, as well as its beautiful cherry blossoms.", "quiz_question": "What seasonal flower is famously associated with Japan?", "quiz_answer": "Cherry blossoms", "biome": "forest", "biome_color": "#228b22" },
          "southkorea": { "continent": "Asia", "name": "South Korea", "bio": "South Korea is known for its technological prowess, with major companies like Samsung, and for the global phenomenon of K-Pop music.", "quiz_question": "What genre of music from South Korea has become a global phenomenon?", "quiz_answer": "K-Pop", "biome": "temperate", "biome_color": "#6b8e23" },
          "northkorea": { "continent": "Asia", "name": "North Korea", "bio": "North Korea is one of the most isolated and secretive countries in the world, governed by a totalitarian regime.", "quiz_question": "What type of government does North Korea have?", "quiz_answer": "Totalitarian", "biome": "temperate", "biome_color": "#6b8e23" },
          "china": { "continent": "Asia", "name": "China", "bio": "China is the world's most populous country and home to the Great Wall, one of the most impressive architectural feats in human history.", "quiz_question": "What famous landmark in China is one of the world's largest construction projects?", "quiz_answer": "Great Wall", "biome": "temperate", "biome_color": "#6b8e23" },
          "mongolia": { "continent": "Asia", "name": "Mongolia", "bio": "Mongolia is the most sparsely populated sovereign country in the world, known for its vast, rugged expanses and nomadic culture.", "quiz_question": "What culture describes Mongolian citizens?", "quiz_answer": "nomadic", "biome": "desert", "biome_color": "#f4a460" },
          "kazakhstan": { "continent": "Asia", "name": "Kazakhstan", "bio": "Kazakhstan is the world's largest landlocked country and is the site of the Baikonur Cosmodrome, the world's first and largest operational space launch facility.", "quiz_question": "What important space facility is located in Kazakhstan?", "quiz_answer": "The Baikonur Cosmodrome.", "biome": "desert", "biome_color": "#f4a460" },
          "uzbekistan": { "continent": "Asia", "name": "Uzbekistan", "bio": "Uzbekistan is one of only two doubly landlocked countries and is famous for its Silk Road cities of Samarkand, Bukhara, and Khiva.", "quiz_question": "What ancient trade route featured famous cities in Uzbekistan?", "quiz_answer": "Silk Road", "biome": "desert", "biome_color": "#f4a460" },
          "kyrgyzstan": { "continent": "Asia", "name": "Kyrgyzstan", "bio": "Kyrgyzstan is a mountainous country known for its nomadic traditions and the epic poem, Manas, which is one of the longest epic poems in the world.", "quiz_question": "What is the name of the famous epic poem from Kyrgyzstan?", "quiz_answer": "Manas", "biome": "temperate", "biome_color": "#6b8e23" },
          "turkmenistan": { "continent": "Asia", "name": "Turkmenistan", "bio": "Turkmenistan is home to the Darvaza gas crater, also known as the 'Gates of Hell,' a natural gas field that has been burning continuously since 1971.", "quiz_question": "What is the nickname of the burning gas crater in Turkmenistan?", "quiz_answer": "The Gates of Hell", "biome": "desert", "biome_color": "#f4a460" },
          "tajikistan": { "continent": "Asia", "name": "Tajikistan", "bio": "Over 90% of Tajikistan is covered by mountains, making it a haven for high-altitude trekking and climbing.", "quiz_question": "What type of terrain covers most of Tajikistan?", "quiz_answer": "Mountains", "biome": "temperate", "biome_color": "#6b8e23" },
          "afghanistan": { "continent": "Asia", "name": "Afghanistan", "bio": "Afghanistan has historically been a crossroads of empires and is known for its rugged mountains and the production of high-quality pomegranates.", "quiz_question": "What fruit is famously grown in Afghanistan?", "quiz_answer": "Pomegranates", "biome": "desert", "biome_color": "#f4a460" },
          "pakistan": { "continent": "Asia", "name": "Pakistan", "bio": "Pakistan is home to K2, the second-highest mountain in the world, considered by climbers to be more challenging to ascend than Mount Everest.", "quiz_question": "What is the name of the second-highest mountain in the world, located in Pakistan?", "quiz_answer": "K2", "biome": "desert", "biome_color": "#f4a460" },
          "turkey": { "continent": "Asia/Europe", "name": "Turkey", "bio": "Turkey straddles two continents and is home to Istanbul, the only city in the world located on both Europe and Asia.", "quiz_question": "What turkish city straddles two continents?", "quiz_answer": "Istanbul", "biome": "temperate", "biome_color": "#6b8e23" },
          "georgia": { "continent": "Asia", "name": "Georgia", "bio": "Georgia is considered the birthplace of wine, with evidence of winemaking dating back 8,000 years.", "quiz_question": "What beverage is believed to have originated in Georgia?", "quiz_answer": "Wine", "biome": "temperate", "biome_color": "#6b8e23" },
          "armenia": { "continent": "Asia", "name": "Armenia", "bio": "Armenia was the first country in the world to officially adopt Christianity as its state religion in 301 AD.", "quiz_question": "When did Armenia adopt Christianity as its state religion?", "quiz_answer": "301 AD", "biome": "temperate", "biome_color": "#6b8e23" },
          "azerbaijan": { "continent": "Asia", "name": "Azerbaijan", "bio": "Azerbaijan is known as the 'Land of Fire' due to its natural burning gas vents and its significant oil and gas reserves.", "quiz_question": "What natural fiery geographical feature is Azerbaijan home to?", "quiz_answer": "burning gas vents", "biome": "desert", "biome_color": "#f4a460" },
          "lebanon": { "continent": "Asia", "name": "Lebanon", "bio": "Lebanon is famous for its ancient cedar forests, mentioned in the Bible, and its vibrant cuisine.", "quiz_question": "What ancient type of tree is a national symbol of Lebanon?", "quiz_answer": "The cedar tree", "biome": "temperate", "biome_color": "#6b8e23" },
          "syria": { "continent": "Asia", "name": "Syria", "bio": "Syria is home to Damascus, one of the oldest continuously inhabited cities in the world.", "quiz_question": "What city in Syria is one of the oldest continuously inhabited?", "quiz_answer": "Damascus", "biome": "desert", "biome_color": "#f4a460" },
          "israel": { "continent": "Asia", "name": "Israel", "bio": "Israel has a high concentration of high-tech companies and is a center of major religious significance for Jews, Christians, and Muslims.", "quiz_question": "What kind of companies does Israel have a high concentration of?", "quiz_answer": "high-tech companies", "biome": "temperate", "biome_color": "#6b8e23" },
          "jordan": { "continent": "Asia", "name": "Jordan", "bio": "Jordan is home to the ancient city of Petra, a breathtaking archaeological site famous for its rock-cut architecture.", "quiz_question": "What is the famous ancient city in Jordan known for its rock-cut architecture?", "quiz_answer": "Petra", "biome": "desert", "biome_color": "#f4a460" },
          "iraq": { "continent": "Asia", "name": "Iraq", "bio": "Iraq is located in the region of ancient Mesopotamia, often called the 'Cradle of Civilization,' where writing and cities first emerged.", "quiz_question": "What is the historical region of Iraq often called?", "quiz_answer": "The Cradle of Civilization", "biome": "desert", "biome_color": "#f4a460" },
          "iran": { "continent": "Asia", "name": "Iran", "bio": "Iran, historically known as Persia, is famous for its exquisite Persian carpets and intricate mosaic-covered mosques.", "quiz_question": "What traditional craft is Iran, or Persia, famous for?", "quiz_answer": "Persian carpets", "biome": "desert", "biome_color": "#f4a460" },
          "saudiarabia": { "continent": "Asia", "name": "Saudi Arabia", "bio": "Saudi Arabia is the birthplace of Islam and home to its two holiest cities, Mecca and Medina.", "quiz_question": "What are the two holiest cities of Islam, located in Saudi Arabia?", "quiz_answer": "Mecca and Medina", "biome": "desert", "biome_color": "#f4a460" },
          "yemen": { "continent": "Asia", "name": "Yemen", "bio": "Yemen is known for the unique, ancient 'skyscraper' city of Shibam, where buildings are made from mudbrick.", "quiz_question": "What city is famous for mudbrick skyscraper buildings?", "quiz_answer": "Shibam", "biome": "desert", "biome_color": "#f4a460" },
          "oman": { "continent": "Asia", "name": "Oman", "bio": "Oman is known for its traditional dhow boats, historic forts, and as a major producer of high-quality frankincense.", "quiz_question": "What aromatic resin has been historically sourced from Oman?", "quiz_answer": "Frankincense", "biome": "desert", "biome_color": "#f4a460" },
          "uae": { "continent": "Asia", "name": "United Arab Emirates", "bio": "The UAE is famous for its futuristic cities like Dubai, which is home to the world's tallest building, the Burj Khalifa.", "quiz_question": "What is the name of the world's tallest building?", "quiz_answer": "The Burj Khalifa", "biome": "desert", "biome_color": "#f4a460" },
          "qatar": { "continent": "Asia", "name": "Qatar", "bio": "Qatar is one of the richest countries in the world per capita, due to its vast natural gas reserves, and it hosted the 2022 FIFA World Cup.", "quiz_question": "What year did Qatar host the FIFA World Cup?", "quiz_answer": "2022", "biome": "desert", "biome_color": "#f4a460" },
          "kuwait": { "continent": "Asia", "name": "Kuwait", "bio": "Kuwait's wealth is primarily based on its large oil reserves, and the Kuwaiti dinar is typically the highest-valued currency unit in the world.", "quiz_question": "What is the currency of Kuwait?", "quiz_answer": "Kuwaiti Dinar", "biome": "desert", "biome_color": "#f4a460" },
          "india": { "continent": "Asia", "name": "India", "bio": "India is the world's largest democracy and is known for its incredible diversity of cultures, languages, and religions, as well as landmarks like the Taj Mahal.", "quiz_question": "What is the famous white marble mausoleum in India called?", "quiz_answer": "The Taj Mahal", "biome": "temperate", "biome_color": "#6b8e23" },
          "srilanka": { "continent": "Asia", "name": "Sri Lanka", "bio": "Sri Lanka, known as the 'Pearl of the Indian Ocean,' is a major producer of tea and is famous for its ancient Buddhist ruins.", "quiz_question": "What beverage is a major export of Sri Lanka?", "quiz_answer": "Tea", "biome": "rainforest", "biome_color": "#2e8b57" },
          "nepal": { "continent": "Asia", "name": "Nepal", "bio": "Nepal is home to Mount Everest, the highest peak on Earth, and is the birthplace of Siddhartha Gautama, the Buddha.", "quiz_question": "What is the highest mountain in the world, located in Nepal?", "quiz_answer": "Mount Everest", "biome": "temperate", "biome_color": "#6b8e23" },
          "bangladesh": { "continent": "Asia", "name": "Bangladesh", "bio": "Bangladesh is one of the most densely populated countries in the world and is characterized by its lush greenery and many waterways.", "quiz_question": "Is Bangladesh densely or sparsely populated?", "quiz_answer": "Densely", "biome": "temperate", "biome_color": "#6b8e23" },
          "myanmar": { "continent": "Asia", "name": "Myanmar", "bio": "Myanmar, formerly Burma, is famous for the ancient city of Bagan, where thousands of Buddhist temples and pagodas dot the landscape.", "quiz_question": "What is the ancient city in Myanmar famous for its thousands of temples?", "quiz_answer": "Bagan", "biome": "rainforest", "biome_color": "#2e8b57" },
          "thailand": { "continent": "Asia", "name": "Thailand", "bio": "Thailand is known for its ornate temples, beautiful beaches, and delicious cuisine. It is the only country in Southeast Asia that was never colonized by a European power.", "quiz_question": "Was Thailand ever colonized by a European power?", "quiz_answer": "No", "biome": "rainforest", "biome_color": "#2e8b57" },
          "laos": { "continent": "Asia", "name": "Laos", "bio": "Laos is the only landlocked country in Southeast Asia and is the most heavily bombed country in history per capita.", "quiz_question": "Laos is the most what per capita?", "quiz_answer": "bombed", "biome": "rainforest", "biome_color": "#2e8b57" },
          "vietnam": { "continent": "Asia", "name": "Vietnam", "bio": "Vietnam is famous for its stunning natural beauty, such as Ha Long Bay with its thousands of limestone islands, and its resilient history.", "quiz_question": "What is the name of the famous bay in Vietnam known for its limestone islands?", "quiz_answer": "Ha Long Bay", "biome": "rainforest", "biome_color": "#2e8b57" },
          "cambodia": { "continent": "Asia", "name": "Cambodia", "bio": "Cambodia is home to Angkor Wat, the world's largest religious monument, originally built as a Hindu temple.", "quiz_question": "What is the name of the world's largest religious monument, located in Cambodia?", "quiz_answer": "Angkor Wat", "biome": "rainforest", "biome_color": "#2e8b57" },
          "malaysia": { "continent": "Asia", "name": "Malaysia", "bio": "Malaysia is a multicultural country known for its biodiverse rainforests and the iconic Petronas Twin Towers in Kuala Lumpur.", "quiz_question": "What were the world's tallest buildings from 1998 to 2004, located in Malaysia?", "quiz_answer": "The Petronas Twin Towers", "biome": "rainforest", "biome_color": "#2e8b57" },
          "taiwan": { "continent": "Asia", "name": "Taiwan", "bio": "Taiwan is a global leader in the manufacturing of semiconductors and is famous for its bustling night markets and bubble tea.", "quiz_question": "What popular drink was invented in Taiwan?", "quiz_answer": "Bubble tea", "biome": "temperate", "biome_color": "#6b8e23" },
          "philippines": { "continent": "Asia", "name": "Philippines", "bio": "The Philippines is an archipelago of over 7,000 islands, known for its stunning beaches, rice terraces, and vibrant Catholic festivals.", "quiz_question": "What kind of festivals are held in the Phillippines?", "quiz_answer": "Catholic", "biome": "rainforest", "biome_color": "#2e8b57" },
          "indonesia": { "continent": "Asia", "name": "Indonesia", "bio": "Indonesia is the world's largest archipelago, with over 17,000 islands, and it has the largest Muslim population in the world.", "quiz_question": "How many islands make up Indonesia?", "quiz_answer": "17,000", "biome": "rainforest", "biome_color": "#2e8b57" },
          "easttimor": { "continent": "Asia", "name": "East Timor", "bio": "East Timor, or Timor-Leste, is one of the world's newest countries, gaining independence in 2002, and is known for its rich marine biodiversity.", "quiz_question": "In what year did East Timor gain independence?", "quiz_answer": "2002", "biome": "rainforest", "biome_color": "#2e8b57" },
          "australia": { "continent": "Australia/Oceania", "name": "Australia", "bio": "Australia is both a continent and a country, famous for its unique wildlife like kangaroos and koalas, and natural wonders like the Great Barrier Reef.", "quiz_question": "What is the world's largest coral reef system, located off the coast of Australia?", "quiz_answer": "The Great Barrier Reef", "biome": "desert", "biome_color": "#f4a460" },
          "newguinea": { "continent": "Australia/Oceania", "name": "Papua New Guinea", "bio": "Papua New Guinea is one of the most culturally diverse countries in the world, with over 800 indigenous languages spoken.", "quiz_question": "More than how many languages are indigenous to Papua New Guinea?", "quiz_answer": "800", "biome": "rainforest", "biome_color": "#2e8b57" },
          "solomonislands": { "continent": "Australia/Oceania", "name": "Solomon Islands", "bio": "The Solomon Islands are a nation of hundreds of islands, known for their pivotal role in World War II and their incredible scuba diving sites.", "quiz_question": "What major historical conflict had significant battles in the Solomon Islands?", "quiz_answer": "World War II", "biome": "rainforest", "biome_color": "#2e8b57" },
          "vanuatu": { "continent": "Australia/Oceania", "name": "Vanuatu", "bio": "Vanuatu is an archipelago famous for its active volcanoes, including Mount Yasur, and is the birthplace of bungee jumping.", "quiz_question": "What modern extreme sport originated as a ritual in Vanuatu?", "quiz_answer": "Bungee jumping", "biome": "rainforest", "biome_color": "#2e8b57" },
          "fiji": { "continent": "Australia/Oceania", "name": "Fiji", "bio": "Fiji is an archipelago of more than 300 islands, famous for its rugged landscapes, coral reefs, and as a major producer of bottled water.", "quiz_question": "What beverage is a major export for Fiji?", "quiz_answer": "Bottled water", "biome": "rainforest", "biome_color": "#2e8b57" },
          "newcaledonia": { "continent": "Australia/Oceania", "name": "New Caledonia", "bio": "New Caledonia is a French territory known for its large barrier reef, which is second in length only to the Great Barrier Reef.", "quiz_question": "New Caledonia is what country's territory?", "quiz_answer": "France", "biome": "rainforest", "biome_color": "#2e8b57" },
          "newzealand": { "continent": "Australia/Oceania", "name": "New Zealand", "bio": "New Zealand is renowned for its stunning landscapes, which served as the filming locations for 'The Lord of the Rings' trilogy, and for being the first country to grant women the right to vote.", "quiz_question": "What major film series showcased New Zealand's landscapes to the world?", "quiz_answer": "The Lord of the Rings", "biome": "temperate", "biome_color": "#6b8e23" },
          "frenchsouthernandantarcticlands": { "continent": "Antarctica", "name": "French Southern and Antarctic Lands", "bio": "This territory consists of remote subantarctic islands and a slice of Antarctica, serving primarily as a base for scientific research.", "quiz_question": "What is the main human activity in the French Southern and Antarctic Lands?", "quiz_answer": "Scientific research", "biome": "tundra", "biome_color": "#add8e6" },
          "antarctica": { "continent": "Antarctica", "name": "Antarctica", "bio": "Antarctica is the Earth's southernmost continent, a virtually uninhabited, ice-covered landmass dedicated to peace and science by international treaty.", "quiz_question": "What is Antarctica primarily dedicated to by international agreement?", "quiz_answer": "Peace and science", "biome": "tundra", "biome_color": "#add8e6" }
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- MAP AND UI SETUP ---
            let currentTileLayer = null;
            const map = L.map('map', { preferCanvas: true, zoomControl: false, worldCopyJump: true }).setView([20, 0], 2);
            L.control.zoom({ position: 'topright' }).addTo(map);
            let tooltipLayerGroup = L.layerGroup().addTo(map);

            // --- STATE VARIABLES ---
            let geoJsonLayer, selectedCountryLayer = null, timerInterval = null, hintRevealInterval = null;
            let userAnswers = {}, countryData = {}, allCountries = [], countryPath = [];
            let countryDetails = {}; // To store data from countries.json
            let quizState = 'explore'; // 'explore', 'pre-start', 'playing', 'finished'
            let playStyle = 'explore'; // 'explore', 'timed', 'paced', 'sprint'
            let tabOrder = 'random';
            let difficulty = 'normal'; // 'easy', 'normal', 'hard', 'extreme', 'mirror'
            let theme = 'voyager'; // 'voyager', 'midnight', 'earth', 'oceanic'
            let quizSequence = [];
            let currentSequenceIndex = -1;
            let exploredCountries = {};
            const PROGRESS_KEY = 'worldQuizProgress';
            const PROFILE_STATS_KEY = 'worldQuizProfileStats';

            // --- PROFILE AND STATS ---
            let profileStats;

            const achievements = {
                firstGame: { title: "Welcome Aboard!", description: "Play your first quiz game.", unlocked: false },
                explorer10: { title: "Novice Explorer", description: "Explore 10 different countries.", unlocked: false },
                explorer50: { title: "Seasoned Explorer", description: "Explore 50 different countries.", unlocked: false },
                globetrotter: { title: "Globetrotter", description: "Explore all countries.", unlocked: false },
                perfectScore: { title: "Perfectionist", description: "Get a 100% score in any quiz mode.", unlocked: false },
                sprintMaster: { title: "Sprint Master", description: "Score over 20,000 in Sprint mode.", unlocked: false },
                timeBender: { title: "Time Bender", description: "Finish a Timed quiz with over 5 minutes remaining.", unlocked: false },
                allModes: { title: "Jack of All Trades", description: "Play every game mode at least once.", unlocked: false }
            };

            function initializeDefaultStats() {
                const defaultStats = {
                    gamesPlayed: 0,
                    totalTimePlayed: 0, // in seconds
                    totalCorrectGuesses: 0,
                    totalGuesses: 0,
                    countriesExplored: 0,
                    bestScores: {
                        timed: { score: 0, total: 0, time: 0 },
                        paced: { score: 0, total: 0 },
                        sprint: { score: 0 }
                    },
                    modesPlayed: {
                        timed: 0,
                        paced: 0,
                        sprint: 0
                    },
                    achievements: {}
                };
                // Initialize achievements from the main definition
                for (const key in achievements) {
                    defaultStats.achievements[key] = false;
                }
                return defaultStats;
            }

            function loadProfileStats() {
                try {
                    const savedStats = localStorage.getItem(PROFILE_STATS_KEY);
                    if (savedStats) {
                        profileStats = JSON.parse(savedStats);
                        // Ensure achievements object is in sync with the definition
                        for (const key in achievements) {
                            if (!(key in profileStats.achievements)) {
                                profileStats.achievements[key] = false;
                            }
                        }
                    } else {
                        profileStats = initializeDefaultStats();
                    }
                } catch (e) {
                    console.error("Could not load profile stats:", e);
                    profileStats = initializeDefaultStats();
                }
            }

            function saveProfileStats() {
                try {
                    localStorage.setItem(PROFILE_STATS_KEY, JSON.stringify(profileStats));
                } catch (e) {
                    console.error("Could not save profile stats:", e);
                }
            }

            function updateProfileStats(gameResult) {
                profileStats.gamesPlayed++;
                profileStats.totalTimePlayed += gameResult.timeSpent;
                profileStats.totalCorrectGuesses += gameResult.correctCount;
                profileStats.totalGuesses += gameResult.totalCountries;
                profileStats.modesPlayed[gameResult.playStyle]++;

                // Update best scores
                const bs = profileStats.bestScores;
                switch (gameResult.playStyle) {
                    case 'timed':
                        if (gameResult.correctCount > bs.timed.score || (gameResult.correctCount === bs.timed.score && gameResult.timeSpent < bs.timed.time)) {
                            bs.timed = { score: gameResult.correctCount, total: gameResult.totalCountries, time: gameResult.timeSpent };
                        }
                        break;
                    case 'paced':
                        if (gameResult.correctCount > bs.paced.score) {
                            bs.paced = { score: gameResult.correctCount, total: gameResult.totalCountries };
                        }
                        break;
                    case 'sprint':
                        if (gameResult.sprintScore > bs.sprint.score) {
                            bs.sprint.score = gameResult.sprintScore;
                        }
                        break;
                }
                
                checkAchievements(gameResult);
                saveProfileStats();
            }

            function checkAchievements(gameResult) {
                // First Game
                if (!profileStats.achievements.firstGame) unlockAchievement('firstGame');

                // Explorer achievements
                profileStats.countriesExplored = Object.keys(exploredCountries).length;
                if (profileStats.countriesExplored >= 10 && !profileStats.achievements.explorer10) unlockAchievement('explorer10');
                if (profileStats.countriesExplored >= 50 && !profileStats.achievements.explorer50) unlockAchievement('explorer50');
                if (profileStats.countriesExplored === allCountries.length && !profileStats.achievements.globetrotter) unlockAchievement('globetrotter');

                // Game result based achievements
                if (gameResult) {
                    if (gameResult.correctCount === gameResult.totalCountries && !profileStats.achievements.perfectScore) unlockAchievement('perfectScore');
                    if (gameResult.playStyle === 'sprint' && gameResult.sprintScore > 20000 && !profileStats.achievements.sprintMaster) unlockAchievement('sprintMaster');
                    if (gameResult.playStyle === 'timed' && (15 * 60 - gameResult.timeSpent) > 300 && !profileStats.achievements.timeBender) unlockAchievement('timeBender');
                    
                    const { timed, paced, sprint } = profileStats.modesPlayed;
                    if (timed > 0 && paced > 0 && sprint > 0 && !profileStats.achievements.allModes) unlockAchievement('allModes');
                }
            }
            
            function unlockAchievement(key) {
                if (!profileStats.achievements[key]) {
                    profileStats.achievements[key] = true;
                    // Optional: show a notification to the user
                    console.log(`Achievement Unlocked: ${achievements[key].title}`);
                    saveProfileStats();
                }
            }


            function displayProfileStats() {
                loadProfileStats(); // Make sure we have the latest stats
                
                document.getElementById('stat-games-played').textContent = profileStats.gamesPlayed;
                const totalMinutes = Math.round(profileStats.totalTimePlayed / 60);
                document.getElementById('stat-time-played').textContent = `${totalMinutes}m`;
                const accuracy = profileStats.totalGuesses > 0 ? Math.round((profileStats.totalCorrectGuesses / profileStats.totalGuesses) * 100) : 0;
                document.getElementById('stat-accuracy').textContent = `${accuracy}%`;
                document.getElementById('stat-countries-explored').textContent = `${profileStats.countriesExplored} / ${allCountries.length}`;

                // Best Scores
                const bs = profileStats.bestScores;
                document.getElementById('best-score-timed').textContent = `${bs.timed.score} / ${bs.timed.total}`;
                document.getElementById('best-time-timed').textContent = `Time: ${bs.timed.time}s`;
                document.getElementById('best-score-paced').textContent = `${bs.paced.score} / ${bs.paced.total}`;
                document.getElementById('best-score-sprint').textContent = bs.sprint.score;

                // Achievements
                const achievementsContainer = document.getElementById('achievements-container');
                achievementsContainer.innerHTML = '';
                for (const key in achievements) {
                    const isUnlocked = profileStats.achievements[key];
                    const achievement = achievements[key];
                    const badgeHTML = `
                        <div class="achievement-badge ${isUnlocked ? 'unlocked' : 'locked'} p-4 rounded-lg text-center shadow-md cursor-pointer stat-card" title="${achievement.description}">
                            <p class="text-4xl mb-2">${isUnlocked ? '🏆' : '❓'}</p>
                            <p class="font-bold text-sm">${achievement.title}</p>
                        </div>
                    `;
                    achievementsContainer.innerHTML += badgeHTML;
                }
            }


            // --- LOCALSTORAGE FUNCTIONS ---
            function saveProgress() {
                try {
                    const progress = {
                        exploredCountries,
                        userAnswers,
                        score,
                        quizState,
                        playStyle,
                        difficulty,
                        tabOrder,
                        theme,
                        quizSequence: quizSequence.map(c => c.name), // Save names instead of layers
                        currentSequenceIndex,
                        quizStartTime,
                        zenTimeElapsed,
                        timeRemaining,
                    };
                    localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
                } catch (e) {
                    console.error("Could not save progress:", e);
                }
            }

            function loadProgress() {
                try {
                    const savedProgress = localStorage.getItem(PROGRESS_KEY);
                    if (savedProgress) {
                        const progress = JSON.parse(savedProgress);
                        exploredCountries = progress.exploredCountries || {};
                        userAnswers = progress.userAnswers || {};
                        score = progress.score || 0;
                        quizState = progress.quizState || 'explore';
                        playStyle = progress.playStyle || 'explore';
                        difficulty = progress.difficulty || 'normal';
                        tabOrder = progress.tabOrder || 'random';
                        theme = progress.theme || 'voyager';
                        quizStartTime = progress.quizStartTime || 0;
                        zenTimeElapsed = progress.zenTimeElapsed || 0;
                        timeRemaining = progress.timeRemaining; // Can be undefined, that's ok
                        
                        if (progress.quizSequence) {
                            // We need to wait for allCountries to be populated before we can map names back to layers
                            // This will be handled after the geojson fetch.
                            return progress.quizSequence; 
                        }
                    }
                } catch (e) {
                    console.error("Could not load progress:", e);
                }
                return null;
            }
            
            // --- SCORING AND COMBO STATE ---
            let score = 0;
            let comboCount = 0;
            let comboMultiplier = 1;
            let countrySelectedTimestamp = 0;
            let comboTimerInterval = null;
            const COMBO_DURATION = 5000; // 5 seconds for a combo in Sprint mode
            const PACED_DURATION = 15; // 15 seconds per country in Paced mode

            // --- TIMER STATE ---
            let quizStartTime = 0;
            let zenTimeElapsed = 0;
            let timeRemaining;

            // --- MIRROR MODE STATE ---
            let mirrorTries = 4;

            // --- COUNTRY DATA, ALIASES, AND PATH ---
            const countryNameCorrections = { "Dem. Rep. Congo": "Democratic Republic of the Congo", "Central African Rep.": "Central African Republic", "Dominican Rep.": "Dominican Republic", "Eq. Guinea": "Equatorial Guinea", "Bosnia and Herz.": "Bosnia and Herzegovina", "S. Sudan": "South Sudan", "W. Sahara": "Western Sahara", "Solomon Is.": "Solomon Islands", "Antigua and Barb.": "Antigua and Barbuda", "St. Kitts and Nevis": "Saint Kitts and Nevis", "St. Lucia": "Saint Lucia", "St. Vin. and Gren.": "Saint Vincent and the Grenadines", "Swaziland": "Eswatini", "United Republic of Tanzania": "Tanzania", "Côte d'Ivoire": "Ivory Coast" };
            const countryBundles = { "Greenland": "Denmark", "Western Sahara": "Morocco", "Somaliland": "Somalia", "Northern Cyprus": "Cyprus", "West Bank": "Israel", "Puerto Rico": "United States of America", "French Guiana": "France", "Bermuda": "United Kingdom"};
            const bundledCountries = Object.keys(countryBundles);
            
            const countryAliases = {
                'usa': 'unitedstatesofamerica', 'car': 'centralafricanrepublic', 'uae': 'unitedarabemirates',
                'uk': 'unitedkingdom', 'trinidad': 'trinidadandtobago', 'newguinea': 'papuanewguinea',
                'fasal': 'frenchsouthernandantarcticlands', 'antigua': 'antiguaandbarbuda',
                'saintkitts': 'saintkittsandnevis', 'saintvincent': 'saintvincentandthegrenadines',
                'bahamas': 'thebahamas', 'falklandislands': 'falklandislands(malvinas)',
                'easttimor': 'timorleste', 'northmacedonia': 'macedonia', 'serbia': 'republicofserbia', 'czechia': 'czechrepublic', 'bosnia': 'bosniaandherzegovina'
            };
            const reverseAliases = Object.fromEntries(Object.entries(countryAliases).map(([key, value]) => [value, key]));
            const specialCases = { 'congo': ['democraticrepublicofthecongo', 'republicofthecongo'] };

            const pathData = "Canada usa Mexico Bahamas cuba Jamaica Haiti DominicanRepublic belize Guatemala elsalvador honduras nicaragua costarica panama Colombia venezuela trinidad guyana suriname france ecuador peru Bolivia brazil paray uruguay argentina chile falklandislands Iceland ireland uk Norway Sweden Finland estonia latvia lithuania russia belarus ukraine moldova romania bulgaria cyprus greece macedonia albania serbia kosovo Montenegro bosnia Croatia Slovenia Hungary Slovakia Czechia Poland germany denmark netherlands Belgium Luxembourg Switzerland Lichtenstein austria italy spain portugal morocco algeria Tunisia Libya egypt Mauritania mali burkinafaso niger chad sudan eritrea Djibouti senegal gambia guineabissau guinea sierraleone liberia ivorycoast ghana togo benin nigeria Cameroon car southsudan ethiopia somalia equatorialguinea Gabon congo democraticrepublicofthecongo rwanda Burundi brunei bhutan uganda kenya tanzania angola Zambia Malawi Mozambique Zimbabwe Botswana namibia southafrica lesotho eswatini madagascar japan southkorea northkorea china mongolia kazakhstan uzbekistan Kyrgyzstan turkmenistan Tajikistan Afghanistan pakistan turkey georgia armenia azerbaijan lebanon syria israel jordan iraq iran saudiarabia yemen oman uae Qatar Kuwait india Srilanka nepal Bangladesh Myanmar thailand laos vietnam cambodia Malaysia taiwan philippines indonesia easttimor australia newguinea solomonislands vanuatu Fiji newcaledonia newzealand";

            // --- DOM ELEMENTS ---
            const mainContainer = document.getElementById('main-container');
            const profilePage = document.getElementById('profile-page');
            const profileBtn = document.getElementById('profile-btn');
            const closeProfileBtn = document.getElementById('close-profile-btn');
            const resetStatsBtn = document.getElementById('reset-stats-btn');
            const quizContent = document.getElementById('quiz-content');

            const guessInput = document.getElementById('country-guess-input');
            const finishAttemptBtn = document.getElementById('finish-attempt-btn');
            const scoreModal = document.getElementById('score-modal');
            const finalScoreDisplay = document.getElementById('final-score');
            const finalTotalScoreDisplay = document.getElementById('final-total-score-display');
            const finalTimeDisplay = document.getElementById('final-time-display');
            const scoreDetailsDisplay = document.getElementById('score-details');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const missesContainer = document.getElementById('misses-container');
            const viewFinishedMapBtn = document.getElementById('view-finished-map-btn');
            const backToQuizBtn = document.getElementById('back-to-quiz-btn');
            const subtitle = document.getElementById('subtitle');
            const statusDisplayContainer = document.getElementById('status-display-container');
            const timerDisplay = document.getElementById('timer-display');
            const timerProgressBar = document.getElementById('timer-progress-bar');
            const scoreTitle = document.getElementById('score-title');
            const playStyleOptions = document.getElementById('play-style-options');
            const tabOrderOptions = document.getElementById('tab-order-options');
            const difficultyOptions = document.getElementById('difficulty-options');
            const themeOptions = document.getElementById('theme-options');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const scoreDisplay = document.getElementById('score-display');
            const pointsIndicator = document.getElementById('points-indicator');
            const infoModal = document.getElementById('info-modal');
            const infoModalTitle = document.getElementById('info-modal-title');
            const infoModalBody = document.getElementById('info-modal-body');
            const closeInfoModalBtn = document.getElementById('close-info-modal-btn');
            const learnBtn = document.getElementById('learn-btn');
            const countryInfoPanel = document.getElementById('country-info-panel');
            const countryInfoName = document.getElementById('country-info-name');
            const countryInfoBio = document.getElementById('country-info-bio');
            const exploredCounter = document.getElementById('explored-counter');
            const keepExploringBtn = document.getElementById('keep-exploring-btn');
            const quizSection = document.getElementById('quiz-section');
            const quizQuestion = document.getElementById('quiz-question');
            const quizAnswerInput = document.getElementById('quiz-answer-input');
            const quizSubmitBtn = document.getElementById('quiz-submit-btn');
            const quizFeedback = document.getElementById('quiz-feedback');
            const speakCountryNameBtn = document.getElementById('speak-country-name');

            // --- SVG TIMER SETUP ---
            let progressBarLength; 
            finishAttemptBtn.style.display = 'none';
            
            // --- BIOME DATA ---
            function getCountryBiome(countryName) {
                const details = countryDetails[normalize(countryName)];
                return details ? details.biome : 'temperate';
            }

            // --- THEME DATA ---
            const themes = {
                voyager: {
                    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    mapBg: '#a2d2ff',
                    styles: {
                        default: { fillColor: '#60a5fa', weight: 1, color: '#1e3a8a', fillOpacity: 0.7 },
                        guessed: { fillColor: '#22c55e', weight: 1, color: '#166534', fillOpacity: 0.8 },
                        selected: { weight: 4, color: '#f59e0b', fillColor: '#facc15' },
                        correctFinished: { fillColor: '#22c55e', weight: 1, color: 'white', fillOpacity: 0.9 },
                        incorrectFinished: { fillColor: '#ef4444', weight: 1, color: 'white', fillOpacity: 0.9 },
                        unclickable: { fillColor: '#e5e7eb', weight: 1, color: '#9ca3af', fillOpacity: 0.5 },
                    },
                    classes: { body: "bg-gray-100", container: "bg-white", title: "text-blue-900", settings: "bg-gray-50", settingTitle: "text-gray-700", settingRail: "bg-gray-200", settingInactive: "text-gray-500", settingActive: "bg-white text-gray-800 shadow" }
                },
                midnight: {
                    url: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    mapBg: '#111827',
                    styles: {
                        default: { fillColor: '#6366f1', weight: 1, color: '#a5b4fc', fillOpacity: 0.7 },
                        guessed: { fillColor: '#16a34a', weight: 1, color: '#86efac', fillOpacity: 0.8 },
                        selected: { weight: 4, color: '#f97316', fillColor: '#fdba74' },
                        correctFinished: { fillColor: '#16a34a', weight: 1, color: 'white', fillOpacity: 0.9 },
                        incorrectFinished: { fillColor: '#dc2626', weight: 1, color: 'white', fillOpacity: 0.9 },
                        unclickable: { fillColor: '#374151', weight: 1, color: '#6b7280', fillOpacity: 0.5 },
                    },
                    classes: { body: "bg-gray-900", container: "bg-gray-800", title: "text-indigo-400", settings: "bg-gray-900", settingTitle: "text-gray-300", settingRail: "bg-gray-700", settingInactive: "text-gray-400", settingActive: "bg-indigo-500 text-white shadow-lg" }
                },
                earth: {
                    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    mapBg: '#a2d2ff',
                    styles: {
                        default: { fillColor: '#eeeee4', weight: 1, color: '#422006', fillOpacity: 0.7 },
                        selected: { weight: 4, color: '#ca8a04', fillColor: '#fef08a' },
                        incorrectFinished: { fillColor: '#b91c1c', weight: 1, color: 'white', fillOpacity: 0.9 },
                        unclickable: { fillColor: '#d6d3d1', weight: 1, color: '#a8a29e', fillOpacity: 0.5 },
                        
                        guessed_desert: { fillColor: '#f4a460', weight: 1, color: '#8b4513', fillOpacity: 0.8 }, // Sandy Brown
                        guessed_rainforest: { fillColor: '#2e8b57', weight: 1, color: '#006400', fillOpacity: 0.8 }, // Sea Green
                        guessed_forest: { fillColor: '#228b22', weight: 1, color: '#006400', fillOpacity: 0.8 }, // Forest Green
                        guessed_temperate: { fillColor: '#6b8e23', weight: 1, color: '#556b2f', fillOpacity: 0.8 }, // Olive Drab
                        guessed_tundra: { fillColor: '#add8e6', weight: 1, color: '#4682b4', fillOpacity: 0.8 }, // Light Blue
                        guessed_savanna: { fillColor: '#c3b091', weight: 1, color: '#8b4513', fillOpacity: 0.8 }, // Khaki
                        
                        correctFinished_desert: { fillColor: '#f4a460', weight: 1, color: 'white', fillOpacity: 0.7 },
                        correctFinished_rainforest: { fillColor: '#2e8b57', weight: 1, color: 'white', fillOpacity: 0.7 },
                        correctFinished_forest: { fillColor: '#228b22', weight: 1, color: 'white', fillOpacity: 0.7 },
                        correctFinished_temperate: { fillColor: '#6b8e23', weight: 1, color: 'white', fillOpacity: 0.7 },
                        correctFinished_tundra: { fillColor: '#add8e6', weight: 1, color: 'black', fillOpacity: 0.7 },
                        correctFinished_savanna: { fillColor: '#c3b091', weight: 1, color: 'white', fillOpacity: 0.7 },
                    },
                    classes: { body: "bg-stone-300", container: "bg-stone-100", title: "text-yellow-900", settings: "bg-stone-200", settingTitle: "text-stone-700", settingRail: "bg-stone-300", settingInactive: "text-stone-500", settingActive: "bg-stone-50 text-stone-800 shadow" }
                },
                oceanic: {
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',
                    attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
                    mapBg: '#005f73',
                    styles: {
                        default: { fillColor: '#2a9d8f', weight: 1, color: '#e9d8a6', fillOpacity: 0.7 },
                        guessed: { fillColor: '#94d2bd', weight: 1, color: '#e9d8a6', fillOpacity: 0.8 },
                        selected: { weight: 4, color: '#ee9b00', fillColor: '#fefae0' },
                        correctFinished: { fillColor: '#94d2bd', weight: 1, color: 'black', fillOpacity: 0.9 },
                        incorrectFinished: { fillColor: '#ae2012', weight: 1, color: 'white', fillOpacity: 0.9 },
                        unclickable: { fillColor: '#bbdef0', weight: 1, color: '#9ca3af', fillOpacity: 0.5 },
                    },
                     classes: { body: "bg-cyan-100", container: "bg-cyan-50", title: "text-cyan-900", settings: "bg-cyan-100", settingTitle: "text-cyan-800", settingRail: "bg-cyan-200", settingInactive: "text-cyan-700", settingActive: "bg-white text-orange-600 shadow" }
                }
            };
            
            // --- UTILITY FUNCTIONS ---
            function normalize(str) { return str.toLowerCase().replace(/[\s\.\-&'â]/g, ''); }

            function getVisualCenter(layer) {
                const feature = layer.feature;
                const countryName = feature.properties.name;

                if (countryName === 'Russia') {
                    return L.latLng(60, 100); // Manually set center for Russia to avoid exclave issues
                }
                
                let center = layer.getBounds().getCenter(); 
                if (feature.geometry.type === 'MultiPolygon') {
                    let largestArea = 0;
                    let bestCenter = center;
                    feature.geometry.coordinates.forEach(polygonGroup => {
                        const outerBoundary = polygonGroup[0];
                        const latLngs = outerBoundary.map(coord => [coord[1], coord[0]]); 
                        const tempPolygon = L.polygon(latLngs);
                        const bounds = tempPolygon.getBounds();
                        const area = (bounds.getNorth() - bounds.getSouth()) * (bounds.getEast() - bounds.getWest());
                        if (area > largestArea) {
                            largestArea = area;
                            bestCenter = bounds.getCenter();
                        }
                    });
                    center = bestCenter;
                }
                return center;
            }

            // --- DATA FETCHING AND INITIALIZATION ---
            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(res => res.json())
                .then(geoData => {
                    countryDetails = countriesJsonData; // Use the inlined JSON data

                    geoData.features.forEach(feature => {
                        const originalName = feature.properties.name;
                        if (countryNameCorrections.hasOwnProperty(originalName)) {
                            feature.properties.name = countryNameCorrections[originalName];
                        }
                    });
                    geoData.features = geoData.features.filter(feature => feature.properties.name);

                    geoJsonLayer = L.geoJson(geoData, {
                        style: () => themes[theme].styles.default,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    
                    allCountries = geoData.features
                        .map(feature => {
                            const name = feature.properties.name;
                            if (name === 'Antarctica' || bundledCountries.includes(name)) return null;
                            const layer = countryData[name];
                            return layer ? { name, layer, normalized: normalize(name) } : null;
                        })
                        .filter(Boolean);

                    allCountries.sort((a, b) => a.name.localeCompare(b.name));
                    countryPath = pathData.toLowerCase().split(/\s+/);
                    
                    loadProfileStats();
                    const savedQuizSequence = loadProgress();
                    
                    if (savedQuizSequence) {
                        const countryMap = new Map(allCountries.map(c => [c.name, c]));
                        quizSequence = savedQuizSequence.map(name => countryMap.get(name)).filter(Boolean);
                    }

                    // Set UI based on loaded state
                    applyTheme(theme, true);
                    updatePlayStyleUI(playStyle);
                    
                    // Restore settings UI
                    document.querySelectorAll('#play-style-options button, #tab-order-options button, #difficulty-options button, #theme-options button').forEach(btn => {
                        const container = btn.parentElement;
                        const settingValue = container.id === 'play-style-options' ? playStyle :
                                             container.id === 'tab-order-options' ? tabOrder :
                                             container.id === 'difficulty-options' ? difficulty : theme;
                        if (btn.dataset.value === settingValue) {
                             handleSettingClick({ target: btn }, container.id);
                        }
                    });

                    if (quizState === 'playing') {
                        resumeQuiz();
                    }
                });

            // --- THEME LOGIC ---
            function applyTheme(newThemeName, isInitial = false) {
                const oldThemeName = theme;
                theme = newThemeName;
                const themeData = themes[theme];

                if (currentTileLayer) map.removeLayer(currentTileLayer);
                currentTileLayer = L.tileLayer(themeData.url, {
                    attribution: themeData.attribution,
                    subdomains: 'abcd', maxZoom: 10, minZoom: 2,
                }).addTo(map);
                
                document.documentElement.style.setProperty('--map-bg-color', themeData.mapBg);
                updateThemeClasses(themes[oldThemeName].classes, themeData.classes, isInitial);

                if (geoJsonLayer) {
                    geoJsonLayer.eachLayer(layer => {
                        const name = layer.feature.properties.name;
                        let styleKey;

                        if (quizState === 'finished') {
                            const isGuessed = userAnswers[name] || (countryBundles[name] && userAnswers[countryBundles[name]]);
                            if (isGuessed) {
                                styleKey = (theme === 'earth') ? `correctFinished_${getCountryBiome(name)}` : 'correctFinished';
                            } else {
                                styleKey = 'incorrectFinished';
                            }
                        } else if (layer === selectedCountryLayer) {
                            styleKey = 'selected';
                        } else if (name === 'Antarctica') {
                            styleKey = 'unclickable';
                        } else {
                            const isAnswered = (quizState === 'explore') ? exploredCountries[name] : userAnswers[name];
                            if (isAnswered) {
                                styleKey = (theme === 'earth') ? `guessed_${getCountryBiome(name)}` : 'guessed';
                            } else {
                                styleKey = 'default';
                            }
                        }
                        layer.setStyle(getStyle(styleKey));
                    });
                }
            }
            
            function updateThemeClasses(oldClasses, newClasses, isInitial) {
                 const classMap = {
                    'body': document.body, 'container': document.getElementById('main-container'),
                    'title': document.getElementById('main-title'), 'settings': document.getElementById('settings-panel'),
                    'score-modal-content': document.getElementById('score-modal-content'),
                    'info-modal-content': document.getElementById('info-modal-content')
                };

                Object.keys(classMap).forEach(key => {
                    if (oldClasses[key] && newClasses[key]) {
                        classMap[key].classList.remove(...oldClasses[key].split(' '));
                        classMap[key].classList.add(...newClasses[key].split(' '));
                    }
                });
                
                document.querySelectorAll('.setting-title').forEach(el => {
                    el.classList.remove(...oldClasses.settingTitle.split(' '));
                    el.classList.add(...newClasses.settingTitle.split(' '));
                });

                document.querySelectorAll('.setting-control').forEach(el => {
                    el.classList.remove(...oldClasses.settingRail.split(' '));
                    el.classList.add(...newClasses.settingRail.split(' '));
                    
                    el.querySelectorAll('button').forEach(btn => {
                        if (isInitial) { 
                            if(btn.classList.contains('active')) {
                                btn.classList.add(...newClasses.settingActive.split(' '));
                            } else {
                                btn.classList.add(...newClasses.settingInactive.split(' '));
                            }
                        } else { 
                            if(btn.classList.contains('active')) {
                                btn.classList.remove(...oldClasses.settingActive.split(' '));
                                btn.classList.add(...newClasses.settingActive.split(' '));
                            } else {
                                btn.classList.remove(...oldClasses.settingInactive.split(' '));
                                btn.classList.add(...newClasses.settingInactive.split(' '));
                            }
                        }
                    });
                });
            }

            // --- STYLING FUNCTIONS ---
            function getStyle(styleName) { 
                const style = themes[theme].styles[styleName];
                if (!style && styleName.includes('_')) {
                    const baseStyle = styleName.split('_')[0];
                    return themes[theme].styles[`${baseStyle}_temperate`] || themes[theme].styles['guessed'];
                }
                return style || themes[theme].styles['default'];
            }

            // --- MAP INTERACTION LOGIC ---
            function getMainLayer(layer) {
                const name = layer.feature.properties.name;
                const parentName = countryBundles[name];
                return (parentName && countryData[parentName]) ? countryData[parentName] : layer;
            }

            function onEachFeature(feature, layer) {
                const name = feature.properties.name;
                countryData[name] = layer;
                if (name === 'Antarctica') {
                    layer.setStyle(getStyle('unclickable'));
                    return;
                }
                layer.on({
                    mouseover: e => { 
                        if (quizState === 'playing' && difficulty !== 'mirror') highlightFeature(getMainLayer(e.target)); 
                        if (quizState === 'explore') highlightFeature(getMainLayer(e.target));
                    },
                    mouseout: e => {
                        const layer = getMainLayer(e.target);
                        if (layer === selectedCountryLayer) return;

                        if (quizState === 'playing' && difficulty !== 'mirror') resetHighlight(layer); 
                        if (quizState === 'explore') resetHighlight(layer);
                    },
                    click: e => {
                        const mainLayer = getMainLayer(e.target);
                        if (quizState === 'explore') {
                            showCountryInfo(mainLayer);
                        } else if (quizState === 'playing') {
                            if (difficulty === 'mirror') {
                                handleMirrorModeClick(mainLayer);
                            } else {
                                selectCountry(mainLayer);
                            }
                        }
                    }
                });
            }

            // --- EXPLORE MODE LOGIC ---
            function hideCountryInfoPanel() {
                if (!countryInfoPanel.classList.contains('opacity-0')) {
                    countryInfoPanel.classList.add('opacity-0', '-translate-x-4', 'pointer-events-none');
                    
                    // Reset quiz UI inside the panel
                    quizSection.style.transition = 'none';
                    quizSection.classList.add('hidden');
                    quizSection.style.opacity = '1';
                    quizAnswerInput.disabled = false;
                    quizAnswerInput.value = '';
                    quizSubmitBtn.disabled = false;
                    quizFeedback.classList.add('hidden');
                    keepExploringBtn.classList.add('hidden');

                    // Show the main explore button again
                    learnBtn.classList.remove('hidden');
                    learnBtn.textContent = 'Continue Exploring';

                    // Reset selected layer styling
                    if (selectedCountryLayer) {
                        resetHighlight(selectedCountryLayer);
                        selectedCountryLayer = null;
                    }
                }
            }

            map.on('moveend zoomend', () => {
                if (quizState === 'explore' && selectedCountryLayer) {
                    const mapBounds = map.getBounds();
                    const countryBounds = selectedCountryLayer.getBounds();
                    
                    // If the country bounds are not intersecting with the map bounds, hide the panel
                    if (!mapBounds.intersects(countryBounds)) {
                        hideCountryInfoPanel();
                    }
                }
            });

            function updateExploredCounter() {
                if (quizState !== 'explore') return;
                const exploredCount = Object.keys(exploredCountries).length;
                const totalCount = allCountries.length;
                exploredCounter.textContent = `Explored: ${exploredCount}/${totalCount}`;
                subtitle.textContent = "Select a country to learn more about it.";
            }

            function showCountryInfo(layer) {
                if (!layer) return;

                const name = layer.feature.properties.name;
                
                if (selectedCountryLayer && selectedCountryLayer !== layer) {
                    resetHighlight(selectedCountryLayer);
                }

                selectedCountryLayer = layer;
                applyTheme(theme);
                layer.bringToFront();

                learnBtn.classList.add('hidden'); // Hide the main explore button
                keepExploringBtn.classList.add('hidden'); // Ensure keep exploring is hidden initially

                const normalizedName = normalize(name);
                const details = countryDetails[normalizedName] || countryDetails[reverseAliases[normalizedName]];

                if (details) {
                    countryInfoName.querySelector('span').textContent = details.name;
                    countryInfoBio.textContent = details.bio;
                    
                    if (details.quiz_question && details.quiz_answer) {
                        showQuiz(details.quiz_question, details.quiz_answer);
                    } else {
                        hideQuiz();
                    }
                } else {
                    countryInfoName.querySelector('span').textContent = name;
                    countryInfoBio.textContent = "No information available for this country.";
                    hideQuiz();
                }

                countryInfoPanel.classList.remove('opacity-0', '-translate-x-4', 'pointer-events-none');
                smartFitBounds(layer);
            }

            function showQuiz(question, correctAnswer) {
                quizSection.style.opacity = '1';
                quizQuestion.textContent = question;
                quizAnswerInput.value = '';
                quizAnswerInput.disabled = false;
                quizSubmitBtn.disabled = false;
                quizFeedback.classList.add('hidden');
                quizSection.classList.remove('hidden');
                quizSection.dataset.correctAnswer = correctAnswer;
            }

            function hideQuiz() {
                quizSection.classList.add('hidden');
            }

            function checkQuizAnswer() {
                const userAnswer = quizAnswerInput.value.trim();
                const correctAnswer = quizSection.dataset.correctAnswer;
                
                if (!userAnswer) return;

                const processedUserAnswer = userAnswer.toLowerCase().replace(/\bthe\b\s*/g, '').trim();
                const processedCorrectAnswer = correctAnswer.toLowerCase().replace(/\bthe\b\s*/g, '').trim();

                if (processedUserAnswer && isGuessCorrect(processedUserAnswer, processedCorrectAnswer)) {
                    quizFeedback.textContent = "Correct! Well done!";
                    quizFeedback.className = "mt-3 text-center font-semibold text-green-600";
                    quizFeedback.classList.remove('hidden');
                    
                    const name = selectedCountryLayer.feature.properties.name;
                    if (!exploredCountries[name]) {
                        exploredCountries[name] = true;
                        profileStats.countriesExplored = Object.keys(exploredCountries).length;
                        checkAchievements();
                        saveProfileStats();
                        updateExploredCounter();
                        saveProgress(); // Save progress after exploring a new country
                    }
                    
                    // Immediately update color to green
                    const styleKey = (theme === 'earth') ? `guessed_${getCountryBiome(name)}` : 'guessed';
                    selectedCountryLayer.setStyle(getStyle(styleKey));
                    getRelatedLayers(selectedCountryLayer).forEach(l => l.setStyle(getStyle(styleKey)));

                    quizAnswerInput.disabled = true;
                    quizSubmitBtn.disabled = true;

                    // Fade out quiz and show keep exploring button
                    setTimeout(() => {
                        quizSection.style.transition = 'opacity 0.5s ease-out';
                        quizSection.style.opacity = '0';
                        setTimeout(() => {
                            quizSection.classList.add('hidden');
                            keepExploringBtn.classList.remove('hidden');
                        }, 500); // Wait for fade out
                    }, 1500); // Wait before fading

                } else {
                    quizFeedback.textContent = "Not quite right. Try again!";
                    quizFeedback.className = "mt-3 text-center font-semibold text-red-600";
                    quizFeedback.classList.remove('hidden');
                    quizAnswerInput.focus();
                }
            }

            // --- EVENT LISTENERS FOR EXPLORE MODE ---
            speakCountryNameBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const countryName = countryInfoName.querySelector('span').textContent;
                if (countryName && countryName !== 'Select a Country') {
                    if (window.speechSynthesis) {
                        window.speechSynthesis.cancel();
                        const utterance = new SpeechSynthesisUtterance(countryName);
                        window.speechSynthesis.speak(utterance);
                    }
                }
            });

            quizSubmitBtn.addEventListener('click', checkQuizAnswer);
            
            quizAnswerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkQuizAnswer();
                }
            });
            
            function exploreRandomCountry() {
                const unexploredCountries = allCountries.filter(c => !exploredCountries[c.name]);
                if (unexploredCountries.length > 0) {
                    const randomIndex = Math.floor(Math.random() * unexploredCountries.length);
                    const randomCountry = unexploredCountries[randomIndex];
                    if (randomCountry && randomCountry.layer) {
                        showCountryInfo(randomCountry.layer);
                        smartFitBounds(randomCountry.layer);
                    }
                } else {
                    hideCountryInfoPanel();
                    subtitle.textContent = "You've explored every country! Congratulations!";
                    learnBtn.classList.add('hidden');
                }
            }

            learnBtn.addEventListener('click', exploreRandomCountry);
            keepExploringBtn.addEventListener('click', exploreRandomCountry);
            
            function handleMirrorModeClick(clickedLayer) {
                const clickedName = clickedLayer.feature.properties.name;
                if (userAnswers[clickedName]) return; 

                const correctName = quizSequence[currentSequenceIndex].name;

                if (clickedName === correctName) {
                    userAnswers[correctName] = true;
                    if (playStyle === 'timed') {
                        timeRemaining += 2;
                        updateTimerDisplay();
                    }
                    if (playStyle === 'sprint') processCorrectGuessForCombo(clickedName, correctName);
                    
                    let styleKey;
                    if (theme === 'earth') {
                        const biome = getCountryBiome(clickedName);
                        styleKey = `guessed_${biome}`;
                    } else {
                        styleKey = 'guessed';
                    }
                    const style = getStyle(styleKey);
                    clickedLayer.setStyle(style);
                    getRelatedLayers(clickedLayer).forEach(l => l.setStyle(style));
                    
                    const allGuessed = Object.keys(userAnswers).length === allCountries.length;
                    if (allGuessed) {
                        finishQuiz('manual');
                    } else {
                        if (playStyle === 'paced') startPacedTimer(true);
                        else promptNextMirrorCountry();
                    }
                } else {
                    mirrorTries--;
                    
                    const incorrectLayer = clickedLayer;
                    const originalStyle = getStyle('default');
                    const flashStyle = getStyle('incorrectFinished');
                    
                    incorrectLayer.setStyle(flashStyle);
                    getRelatedLayers(incorrectLayer).forEach(l => l.setStyle(flashStyle));

                    setTimeout(() => {
                        if (!userAnswers[incorrectLayer.feature.properties.name]) {
                            incorrectLayer.setStyle(originalStyle);
                            getRelatedLayers(incorrectLayer).forEach(l => l.setStyle(originalStyle));
                        }
                    }, 400);


                    if (mirrorTries <= 0) {
                        const correctLayer = countryData[correctName];
                        if (correctLayer) {
                            smartFitBounds(correctLayer);
                            correctLayer.setStyle(getStyle('incorrectFinished'));
                        }
                        
                        setTimeout(() => {
                            if (playStyle === 'paced') {
                                startPacedTimer(true);
                            } else {
                                promptNextMirrorCountry();
                            }
                        }, 1500); 
                    }
                }
            }

            function getRelatedLayers(layer) {
                const name = layer.feature.properties.name;
                const related = [];
                const childrenNames = Object.keys(countryBundles).filter(key => countryBundles[key] === name);
                childrenNames.forEach(childName => countryData[childName] && related.push(countryData[childName]));
                return related;
            }

            function highlightFeature(layer) {
                const name = layer.feature.properties.name;
                const isAnswered = (quizState === 'explore') ? exploredCountries[name] : userAnswers[name];
                if (isAnswered || layer === selectedCountryLayer) return;
                
                const style = { weight: 3, color: getStyle('selected').color };
                layer.setStyle(style);
                getRelatedLayers(layer).forEach(l => l.setStyle(style));
                layer.bringToFront();
            }

            function resetHighlight(layer) {
                const name = layer.feature.properties.name;
                const isAnswered = (quizState === 'explore') ? exploredCountries[name] : userAnswers[name];
                
                let styleKey = isAnswered ? 'guessed' : 'default';
                if (isAnswered && theme === 'earth') {
                    styleKey = `guessed_${getCountryBiome(name)}`;
                }

                const style = getStyle(styleKey);
                layer.setStyle(style);
                getRelatedLayers(layer).forEach(l => l.setStyle(style));
            }
            
            function selectCountry(layer) {
                if (!layer || userAnswers[layer.feature.properties.name]) return;
                clearInterval(hintRevealInterval);

                if (selectedCountryLayer && !userAnswers[selectedCountryLayer.feature.properties.name]) {
                    resetHighlight(selectedCountryLayer);
                }
                selectedCountryLayer = layer;
                selectedCountryLayer.setStyle(getStyle('selected'));
                getRelatedLayers(selectedCountryLayer).forEach(l => l.setStyle(getStyle('selected')));
                selectedCountryLayer.bringToFront();
                guessInput.value = '';
                guessInput.focus();
                
                updateHintDisplay();
                countrySelectedTimestamp = Date.now();
            }

            function updateHintDisplay() {
                if (!selectedCountryLayer) return;
                const name = selectedCountryLayer.feature.properties.name;
                let placeholder = '';

                switch (difficulty) {
                    case 'easy':
                        let revealed = name.split('').map((c) => c === ' ' ? ' ' : '_ ');
                        let unrevealedIndices = [];
                        for(let i=1; i < name.length; i++) {
                            if (name[i] !== ' ') unrevealedIndices.push(i);
                        }
                        revealed[0] = name[0];
                        placeholder = `${revealed.join('')} (${name.length} letters)`;
                        guessInput.placeholder = placeholder;
                        
                        hintRevealInterval = setInterval(() => {
                            if (unrevealedIndices.length > 0) {
                                const randomIndex = Math.floor(Math.random() * unrevealedIndices.length);
                                const indexToReveal = unrevealedIndices.splice(randomIndex, 1)[0];
                                revealed[indexToReveal] = name[indexToReveal];
                                guessInput.placeholder = `${revealed.join('')} (${name.length} letters)`;
                            } else {
                                clearInterval(hintRevealInterval);
                            }
                        }, 3000);
                        break;
                    case 'normal':
                        placeholder = name[0] + name.slice(1).replace(/[a-zA-Z]/g, '_ ');
                        guessInput.placeholder = placeholder;
                        break;
                    case 'hard':
                        placeholder = name.replace(/[a-zA-Z]/g, '_ ');
                        guessInput.placeholder = placeholder;
                        break;
                    case 'extreme':
                        guessInput.placeholder = `Guess the selected country...`;
                        break;
                }
            }


            function smartFitBounds(layer) {
                const bounds = layer.getBounds();
                const lonSpan = Math.abs(bounds.getNorthEast().lng - bounds.getSouthWest().lng);
                const countryName = layer.feature.properties.name;

                if (quizState === 'explore' && window.innerWidth >= 768) { // md breakpoint
                    const panelWidth = 420; // A good estimate for max-w-sm (384px) + p-6 (48px)
                    const targetCenter = getVisualCenter(layer);
                    
                    let targetZoom;
                    if (countryName === 'Russia') {
                        targetZoom = 2;
                    } else if (lonSpan > 180) { // Handle countries crossing the date line like Fiji
                        targetZoom = 4;
                    } else {
                        // Use flyToBounds to determine the best zoom, but don't actually fly
                        targetZoom = map.getBoundsZoom(bounds);
                        const latSpan = bounds.getNorth() - bounds.getSouth();
                        const lngSpan = bounds.getEast() - bounds.getWest();
                        const size = latSpan * lngSpan;
                        let maxZoomLevel = 4;
                        if (size < 50) maxZoomLevel = 5;
                        if (size < 5) maxZoomLevel = 6;
                        targetZoom = Math.min(targetZoom, maxZoomLevel);
                    }

                    // Calculate the new center point with an offset to account for the panel
                    const centerPoint = map.project(targetCenter, targetZoom);
                    const mapSize = map.getSize();
                    const pixelOffset = panelWidth / 2;
                    const newCenterPoint = centerPoint.subtract(new L.Point(pixelOffset, 0));
                    const newLatLng = map.unproject(newCenterPoint, targetZoom);

                    map.flyTo(newLatLng, targetZoom);
                    return;
                }

                // --- Fallback for other modes or small screens ---
                if (playStyle === 'sprint') {
                    if (countryName === 'Russia') map.flyTo(getVisualCenter(layer), 2);
                    else if (lonSpan > 180) map.flyTo(getVisualCenter(layer), 5);
                    else {
                        const latSpan = bounds.getNorth() - bounds.getSouth();
                        const lngSpan = bounds.getEast() - bounds.getWest();
                        const size = latSpan * lngSpan;
                        let maxZoomLevel = 4;
                        if (size < 50) maxZoomLevel = 5;
                        if (size < 5) maxZoomLevel = 6;
                        map.fitBounds(bounds, {maxZoom: maxZoomLevel, paddingTopLeft: [20,20], paddingBottomRight: [20,20]});
                    }
                } else {
                    if (countryName === 'Russia') map.flyTo(getVisualCenter(layer), 2);
                    else if (lonSpan > 180) map.flyTo(getVisualCenter(layer), 5);
                    else {
                        const latSpan = bounds.getNorth() - bounds.getSouth();
                        const lngSpan = bounds.getEast() - bounds.getWest();
                        const size = latSpan * lngSpan;
                        let maxZoomLevel = 4;
                        if (size < 50) maxZoomLevel = 5;
                        if (size < 5) maxZoomLevel = 6;
                        map.flyToBounds(bounds, {maxZoom: maxZoomLevel, paddingTopLeft: [20,20], paddingBottomRight: [20,20]});
                    }
                }
            }
            
            function selectNextCountry() {
                for (let i = 0; i < quizSequence.length; i++) {
                    currentSequenceIndex = (currentSequenceIndex + 1) % quizSequence.length;
                    const nextCountry = quizSequence[currentSequenceIndex];
                    if (!userAnswers[nextCountry.name]) {
                        selectCountry(nextCountry.layer);
                        smartFitBounds(nextCountry.layer);
                        return;
                    }
                }
                finishQuiz('manual');
            }
            
            function promptNextMirrorCountry() {
                for (let i = 0; i < quizSequence.length; i++) {
                    currentSequenceIndex = (currentSequenceIndex + 1) % quizSequence.length;
                    const nextCountry = quizSequence[currentSequenceIndex];
                    if (!userAnswers[nextCountry.name] && (!countryData[nextCountry.name].options || countryData[nextCountry.name].options.fillColor !== getStyle('incorrectFinished').fillColor)) {
                        guessInput.value = `Click on: ${nextCountry.name}`;
                        
                        if (window.speechSynthesis) {
                            window.speechSynthesis.cancel();
                            const utterance = new SpeechSynthesisUtterance(nextCountry.name);
                            window.speechSynthesis.speak(utterance);
                        }

                        mirrorTries = 4;
                        countrySelectedTimestamp = Date.now();
                        return;
                    }
                }
                finishQuiz('manual'); 
            }
            
            function promptPreviousMirrorCountry() {
                for (let i = 0; i < quizSequence.length; i++) {
                    currentSequenceIndex = (currentSequenceIndex - 1 + quizSequence.length) % quizSequence.length;
                    const prevCountry = quizSequence[currentSequenceIndex];
                     if (!userAnswers[prevCountry.name] && (!countryData[prevCountry.name].options || countryData[prevCountry.name].options.fillColor !== getStyle('incorrectFinished').fillColor)) {
                        guessInput.value = `Click on: ${prevCountry.name}`;
                        
                        if (window.speechSynthesis) {
                           window.speechSynthesis.cancel(); 
                           const utterance = new SpeechSynthesisUtterance(prevCountry.name);
                           window.speechSynthesis.speak(utterance);
                        }

                        mirrorTries = 4;
                        countrySelectedTimestamp = Date.now();
                        return;
                    }
                }
                finishQuiz('manual');
            }

            function selectPreviousCountry() {
                for (let i = 0; i < quizSequence.length; i++) {
                    currentSequenceIndex = (currentSequenceIndex - 1 + quizSequence.length) % quizSequence.length;
                    const prevCountry = quizSequence[currentSequenceIndex];
                    if (!userAnswers[prevCountry.name]) {
                        selectCountry(prevCountry.layer);
                        smartFitBounds(prevCountry.layer);
                        return;
                    }
                }
                finishQuiz('manual');
            }

            // --- FUZZY SEARCH AND GUESSING LOGIC ---
            function levenshtein(s1, s2) {
                if (!s1 || !s2) return (s1 || s2).length;
                const matrix = Array(s2.length + 1).fill(null).map(() => Array(s1.length + 1).fill(null));
                for (let i = 0; i <= s1.length; i += 1) matrix[0][i] = i;
                for (let j = 0; j <= s2.length; j += 1) matrix[j][0] = j;
                for (let j = 1; j <= s2.length; j += 1) {
                    for (let i = 1; i <= s1.length; i += 1) {
                        const indicator = s1[i - 1] === s2[j - 1] ? 0 : 1;
                        matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
                    }
                }
                return matrix[s2.length][s1.length];
            }
            
            function isGuessCorrect(guess, correctCountryName) {
                const normalizedGuess = normalize(guess);
                if (!normalizedGuess) return false;
                const normalizedCorrect = normalize(correctCountryName);

                if (normalizedGuess === normalizedCorrect) return true;
                if (countryAliases[normalizedGuess] === normalizedCorrect) return true;
                if (specialCases[normalizedGuess] && specialCases[normalizedGuess].includes(normalizedCorrect)) return true;
                
                const distance = levenshtein(normalizedGuess, normalizedCorrect);
                let threshold = (normalizedCorrect.length >= 10) ? 2 : (normalizedCorrect.length >= 5 ? 1 : 0);
                
                const isFuzzyMatch = distance <= threshold;

                if (isFuzzyMatch) {
                    if (distance > 0 && normalizedGuess.slice(-1) !== normalizedCorrect.slice(-1)) {
                        return false;
                    }
                    return true;
                }
                return false;
            }

            guessInput.addEventListener('input', () => {
                if (difficulty === 'mirror' || !selectedCountryLayer) return;
                const guess = guessInput.value;
                const correctName = selectedCountryLayer.feature.properties.name;
                
                if (isGuessCorrect(guess, correctName)) {
                    if (userAnswers[correctName]) return;

                    clearInterval(hintRevealInterval);
                    userAnswers[correctName] = true;
                    if (playStyle === 'sprint') processCorrectGuessForCombo(guess, correctName);
                    else {
                        handleScoring(guess, correctName);
                    }
                    
                    let styleKey;
                    if (theme === 'earth') {
                        const biome = getCountryBiome(correctName);
                        styleKey = `guessed_${biome}`;
                    } else {
                        styleKey = 'guessed';
                    }
                    const style = getStyle(styleKey);
                    selectedCountryLayer.setStyle(style);
                    getRelatedLayers(selectedCountryLayer).forEach(l => l.setStyle(style));

                    finishAttemptBtn.disabled = false;
                    guessInput.value = '';
                    guessInput.placeholder = `Correct!`;
                    
                    saveProgress();

                    setTimeout(() => {
                        if (playStyle === 'paced') startPacedTimer(true);
                        else selectNextCountry();
                    }, 500);
                }
            });

            // --- SCORING AND COMBO LOGIC ---
            function processCorrectGuessForCombo(guess, correctName) {
                clearInterval(comboTimerInterval);
                comboCount++;
                updateComboMeter();
                handleScoring(guess, correctName);
                startComboTimer();
            }

            function handleScoring(guess, correctName) {
                if (playStyle !== 'sprint') { // Scoring for non-sprint modes
                    score = Object.keys(userAnswers).length;
                    updateScoreDisplay();
                    return;
                }
                const basePoints = 100;
                let accuracyBonus = 50;
                if (difficulty !== 'mirror') {
                    accuracyBonus = Math.max(0, (correctName.length - levenshtein(normalize(guess), normalize(correctName))) / correctName.length) * 50;
                }
                const timeTaken = (Date.now() - countrySelectedTimestamp) / 1000;
                const speedBonus = Math.max(0, 100 - (timeTaken * 5));
                
                const pointsGained = Math.round((basePoints + accuracyBonus + speedBonus) * comboMultiplier);
                score += pointsGained;
                
                updateScoreDisplay();
                showPointsIndicator(pointsGained);
            }

            function startComboTimer() {
                const startTime = Date.now();
                comboTimerInterval = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    const remainingPercentage = Math.max(0, 100 - (elapsedTime / COMBO_DURATION) * 100);
                    const offset = progressBarLength * (1 - (remainingPercentage / 100));
                    timerProgressBar.style.strokeDashoffset = offset;
                    if (remainingPercentage <= 0) {
                        clearInterval(comboTimerInterval);
                        resetCombo();
                    }
                }, 50);
            }

            function resetCombo() {
                comboCount = 0;
                updateComboMeter();
                if(progressBarLength) timerProgressBar.style.strokeDashoffset = progressBarLength;
            }

            function updateScoreDisplay() { 
                if (playStyle === 'sprint') {
                    scoreDisplay.textContent = `Score: ${score}`; 
                } else if (quizState === 'playing') {
                    scoreDisplay.textContent = `Guessed: ${Object.keys(userAnswers).length}/${allCountries.length}`;
                }
            }

            function updateComboMeter() {
                timerDisplay.classList.remove('combo-heat-max');
                comboMultiplier = 1;
                if (comboCount === 0) { timerDisplay.textContent = '1x'; return; }
                if (comboCount === 1) timerDisplay.textContent = '🔥1x';
                else if (comboCount === 2) timerDisplay.textContent = '🔥1x🔥';
                else {
                    comboMultiplier = Math.min(8, 1 + (comboCount - 2)); 
                    timerDisplay.textContent = `${comboMultiplier}x`;
                    if (comboMultiplier >= 8) timerDisplay.classList.add('combo-heat-max');
                }
            }

            function showPointsIndicator(points) {
                pointsIndicator.textContent = `+${points}`;
                pointsIndicator.style.backgroundColor = comboMultiplier > 1 ? '#ef4444' : '#22c55e';
                pointsIndicator.classList.add('show');
                setTimeout(() => { pointsIndicator.classList.remove('show'); }, 1000);
            }

            // --- SETTINGS AND QUIZ LOGIC ---
            function handleSettingClick(e, containerId) {
                const button = e.target.closest('button');
                if (!button) return null;
                const container = document.getElementById(containerId);

                container.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active', ...themes[theme].classes.settingActive.split(' '));
                    btn.classList.add(...themes[theme].classes.settingInactive.split(' '));
                });
                
                button.classList.add('active', ...themes[theme].classes.settingActive.split(' '));
                button.classList.remove(...themes[theme].classes.settingInactive.split(' '));

                return button.dataset.value;
            }

            function updatePlayStyleUI(newPlayStyle) {
                playStyle = newPlayStyle;
                exploredCounter.classList.toggle('hidden', newPlayStyle !== 'explore');
                scoreDisplay.classList.toggle('hidden', newPlayStyle === 'explore');

                if (playStyle === 'explore') {
                    quizState = 'explore';
                    document.getElementById('main-title').textContent = 'World Map Explorer';
                    updateExploredCounter();
                    startQuizBtn.classList.add('hidden');
                    guessInput.classList.add('hidden');
                    learnBtn.classList.remove('hidden');
                    learnBtn.textContent = 'Explore'; // Reset button text
                    learnBtn.parentElement.classList.add('w-full', 'justify-center');
                    finishAttemptBtn.style.display = 'none';
                    tabOrderOptions.parentElement.classList.add('disabled');
                    difficultyOptions.parentElement.classList.add('disabled');
                    statusDisplayContainer.classList.add('hidden');
                    hideCountryInfoPanel();
                } else {
                    quizState = 'pre-start';
                    document.getElementById('main-title').textContent = 'World Map Quiz';
                    subtitle.textContent = "Configure your settings and press Start!";
                    startQuizBtn.classList.remove('hidden');
                    learnBtn.classList.add('hidden');
                    learnBtn.parentElement.classList.remove('w-full', 'justify-center');
                    guessInput.classList.add('hidden');
                    tabOrderOptions.parentElement.classList.remove('disabled');
                    difficultyOptions.parentElement.classList.remove('disabled');
                    countryInfoPanel.classList.add('opacity-0', '-translate-x-4', 'pointer-events-none');
                    selectedCountryLayer = null;
                }
                applyTheme(theme);
                updateTimerDisplay();
            }

            playStyleOptions.addEventListener('click', (e) => {
                const value = handleSettingClick(e, 'play-style-options');
                if (value) updatePlayStyleUI(value);
            });

            tabOrderOptions.addEventListener('click', (e) => {
                const value = handleSettingClick(e, 'tab-order-options');
                if (value) tabOrder = value;
            });
            difficultyOptions.addEventListener('click', (e) => {
                const value = handleSettingClick(e, 'difficulty-options');
                if (value) {
                    difficulty = value;
                    const pathButton = tabOrderOptions.querySelector('button[data-value="path"]');
                    if (difficulty === 'mirror') {
                        pathButton.classList.add('disabled');
                        if (tabOrder === 'path') {
                            tabOrder = 'random';
                            const randomButton = tabOrderOptions.querySelector('button[data-value="random"]');
                            handleSettingClick({ target: randomButton }, 'tab-order-options');
                        }
                    } else {
                        pathButton.classList.remove('disabled');
                    }
                }
            });
            themeOptions.addEventListener('click', (e) => {
                const value = handleSettingClick(e, 'theme-options');
                if(value) applyTheme(value);
            });


            function startQuiz() {
                quizState = 'playing';
                startQuizBtn.classList.add('hidden');
                settingsPanel.classList.add('disabled');
                finishAttemptBtn.style.display = 'inline-block';
                finishAttemptBtn.disabled = false;
                guessInput.classList.remove('hidden');
                
                if (difficulty === 'mirror') {
                    subtitle.textContent = "Click the prompted country on the map.";
                    guessInput.readOnly = true;
                } else {
                    subtitle.textContent = "Click a country or press Tab for a new one!";
                    guessInput.readOnly = false;
                    guessInput.placeholder = 'Type country name...';
                    finishAttemptBtn.disabled = true; 
                }
                
                quizStartTime = Date.now();

                if (!progressBarLength) {
                    progressBarLength = timerProgressBar.getTotalLength();
                    timerProgressBar.style.strokeDasharray = progressBarLength;
                    timerProgressBar.style.strokeDashoffset = progressBarLength;
                }
                
                if (playStyle === 'sprint') scoreDisplay.classList.remove('hidden');
                
                quizSequence = [];
                currentSequenceIndex = -1;
                const countriesForQuiz = allCountries.slice();

                switch(tabOrder) {
                    case 'alphabetical': quizSequence = countriesForQuiz; break;
                    case 'path':
                        if (difficulty === 'mirror') break;
                        const addedCountries = new Set();
                        quizSequence = [];
                        countryPath.forEach(pathName => {
                            const countriesToAdd = allCountries.filter(c => c.normalized === pathName || countryAliases[pathName] === c.normalized || (specialCases[pathName] && specialCases[pathName].includes(c.normalized)));
                            countriesToAdd.forEach(country => {
                                if (!addedCountries.has(country.name)) {
                                    quizSequence.push(country);
                                    addedCountries.add(country.name);
                                }
                            });
                        });
                        quizSequence.push(...allCountries.filter(c => !addedCountries.has(c.name)).sort((a,b) => a.name.localeCompare(b.name)));
                        break;
                    case 'random':
                    default:
                        for (let i = countriesForQuiz.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [countriesForQuiz[i], countriesForQuiz[j]] = [countriesForQuiz[j], countriesForQuiz[i]];
                        }
                        quizSequence = countriesForQuiz;
                        break;
                }
                
                statusDisplayContainer.classList.remove('hidden');
                if (playStyle === 'timed' || playStyle === 'zen') startTimer();
                
                if (difficulty === 'mirror') {
                    if (playStyle === 'paced') startPacedTimer();
                    promptNextMirrorCountry();
                } else {
                    if (playStyle === 'paced') {
                        startPacedTimer(true);
                    } else {
                        selectNextCountry();
                    }
                    guessInput.focus();
                }
                updateTimerDisplay();
            }

            startQuizBtn.addEventListener('click', startQuiz);
            
            function finishQuiz(reason) {
                quizState = 'finished';
                const timeSpent = Math.round((Date.now() - quizStartTime) / 1000);
                stopAllTimers();
                
                let correctCount = Object.keys(userAnswers).length;
                let missesHTML = '';
                
                const gameResult = {
                    playStyle: playStyle,
                    timeSpent: timeSpent,
                    correctCount: correctCount,
                    totalCountries: allCountries.length,
                    sprintScore: score
                };
                if (playStyle !== 'explore') {
                    updateProfileStats(gameResult);
                }

                geoJsonLayer.eachLayer(layer => {
                    const name = layer.feature.properties.name;
                    if (name === 'Antarctica' || bundledCountries.includes(name) || name === 'Falkland Islands (Malvinas)') return;

                    const isGuessed = userAnswers[name];
                    const wasMissed = layer.options.fillColor === getStyle('incorrectFinished').fillColor;

                    if (!isGuessed || wasMissed) {
                         missesHTML += `<div class="p-2 my-1 rounded bg-red-100 text-red-800">You missed: <strong>${name}</strong>.</div>`;
                    }
                });

                if(missesHTML === '') missesHTML = `<p class="text-green-700">Perfect score!</p>`;

                if (reason === 'time') {
                    scoreTitle.textContent = "Time's Up!";
                } else {
                    scoreTitle.textContent = "Your Score";
                }
                
                finalScoreDisplay.textContent = `${correctCount}/${allCountries.length}`;
                scoreDetailsDisplay.textContent = `You correctly identified ${correctCount} out of ${allCountries.length} countries.`;
                missesContainer.innerHTML = missesHTML;
                
                const finalTime = (playStyle === 'zen') ? zenTimeElapsed : timeSpent;
                const minutes = Math.floor(finalTime / 60);
                const seconds = finalTime % 60;
                finalTimeDisplay.textContent = `Total Time: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (playStyle === 'sprint') {
                    finalTotalScoreDisplay.textContent = `Final Score: ${score}`;
                    finalTotalScoreDisplay.classList.remove('hidden');
                } else {
                    finalTotalScoreDisplay.classList.add('hidden');
                }
                
                localStorage.removeItem(PROGRESS_KEY); // Clear progress after finishing

                scoreModal.classList.remove('hidden');
                scoreModal.classList.add('flex');
                setTimeout(() => scoreModal.querySelector('#score-modal-content').classList.remove('scale-95', 'opacity-0'), 50);
            }

            finishAttemptBtn.addEventListener('click', () => finishQuiz('manual'));
            
            function hideModal(modal) {
                const content = modal.querySelector('div');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                     modal.classList.add('hidden');
                     modal.classList.remove('flex');
                     content.classList.remove('scale-95', 'opacity-0'); 
                }, 300);
            }

            closeModalBtn.addEventListener('click', () => { hideModal(scoreModal); resetGame(); });
            viewFinishedMapBtn.addEventListener('click', () => { hideModal(scoreModal); showFinishedMap(); });
            backToQuizBtn.addEventListener('click', () => resetGame());

            function showFinishedMap() {
                quizState = 'finished';
                document.getElementById('quiz-controls-container').classList.add('hidden');
                settingsPanel.classList.add('hidden');
                finishAttemptBtn.classList.add('hidden');
                backToQuizBtn.classList.remove('hidden');
                subtitle.textContent = "Here's a review of your answers.";
                scoreDisplay.classList.add('hidden');
                statusDisplayContainer.classList.add('hidden');
                tooltipLayerGroup.clearLayers();
                
                geoJsonLayer.eachLayer(layer => {
                    const countryName = layer.feature.properties.name;
                    if (countryName === 'Antarctica') return;
                    layer.unbindTooltip();
                    
                    let styleKey;
                    const isGuessed = userAnswers[countryName] || (countryBundles[countryName] && userAnswers[countryBundles[countryName]]);
                    
                    if (isGuessed) {
                        if (theme === 'earth') {
                            const biome = getCountryBiome(countryName);
                            styleKey = `correctFinished_${biome}`;
                        } else {
                            styleKey = 'correctFinished';
                        }
                    } else {
                        styleKey = 'incorrectFinished';
                    }
                    layer.setStyle(getStyle(styleKey));
                    
                    const center = getVisualCenter(layer);
                    L.marker(center, { opacity: 0 })
                        .bindTooltip(countryName, { permanent: true, direction: 'center', className: 'permanent-tooltip' })
                        .addTo(tooltipLayerGroup);
                });
            }

            function resetGame() {
                updatePlayStyleUI('explore');
                const exploreButton = playStyleOptions.querySelector('button[data-value="explore"]');
                handleSettingClick({ target: exploreButton }, 'play-style-options');


                settingsPanel.classList.remove('disabled');
                document.getElementById('quiz-controls-container').classList.remove('hidden');
                backToQuizBtn.classList.add('hidden');
                scoreDisplay.classList.add('hidden');
                tooltipLayerGroup.clearLayers();
                
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
                
                geoJsonLayer.eachLayer(layer => {
                    layer.unbindTooltip();
                });

                userAnswers = {};
                selectedCountryLayer = null;
                guessInput.value = '';
                guessInput.placeholder = 'Type country name...';
                score = 0;
                quizStartTime = 0;
                zenTimeElapsed = 0;
                mirrorTries = 4;
                updateScoreDisplay();
                stopAllTimers();
                resetCombo();
                updateComboMeter();
                if (progressBarLength) timerProgressBar.style.strokeDashoffset = progressBarLength;
                updateTimerDisplay();
                
                // Clear progress from localStorage
                localStorage.removeItem(PROGRESS_KEY);
                // Then save the now-cleared state (which is effectively empty)
                saveProgress();
            }
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab' && quizState === 'playing') {
                    e.preventDefault();
                    if (difficulty === 'mirror') {
                        if (e.shiftKey) {
                           promptPreviousMirrorCountry();
                        } else {
                           promptNextMirrorCountry();
                        }
                    } else {
                        if (e.shiftKey) {
                            selectPreviousCountry();
                        } else {
                            selectNextCountry();
                        }
                    }
                }
            });

            function resumeQuiz() {
                quizState = 'playing';
                startQuizBtn.classList.add('hidden');
                settingsPanel.classList.add('disabled');
                finishAttemptBtn.style.display = 'inline-block';
                finishAttemptBtn.disabled = Object.keys(userAnswers).length === 0;
                guessInput.classList.remove('hidden');
                
                if (difficulty === 'mirror') {
                    subtitle.textContent = "Click the prompted country on the map.";
                    guessInput.readOnly = true;
                } else {
                    subtitle.textContent = "Click a country or press Tab for a new one!";
                    guessInput.readOnly = false;
                }

                if (!progressBarLength) {
                    progressBarLength = timerProgressBar.getTotalLength();
                    timerProgressBar.style.strokeDasharray = progressBarLength;
                    timerProgressBar.style.strokeDashoffset = progressBarLength;
                }
                
                scoreDisplay.classList.remove('hidden');
                updateScoreDisplay();
                
                statusDisplayContainer.classList.remove('hidden');
                if (playStyle === 'timed' || playStyle === 'zen') startTimer();
                
                const lastCountry = quizSequence[currentSequenceIndex];
                if (lastCountry && lastCountry.layer) {
                    if (difficulty === 'mirror') {
                        promptNextMirrorCountry(); // This will find the correct next one
                    } else {
                        selectCountry(lastCountry.layer);
                        smartFitBounds(lastCountry.layer);
                    }
                } else {
                     if (difficulty === 'mirror') promptNextMirrorCountry();
                     else selectNextCountry();
                }

                if (playStyle === 'paced') {
                    startPacedTimer(false); // Don't move to next, just start timer
                }
            }

            // --- TIMER LOGIC ---
            let pacedTimeRemaining;

            function startTimer() {
                if (playStyle === 'timed') {
                    timeRemaining = 15 * 60;
                    timerInterval = setInterval(() => {
                        timeRemaining--;
                        updateTimerDisplay();
                        if (timeRemaining <= 0) finishQuiz('time');
                    }, 1000);
                } else if (playStyle === 'zen') {
                    zenTimeElapsed = 0;
                     timerInterval = setInterval(() => {
                        zenTimeElapsed++;
                        updateTimerDisplay();
                    }, 1000);
                }
                updateTimerDisplay();
            }

            function startPacedTimer(moveToNext = false) {
                stopAllTimers();
                pacedTimeRemaining = PACED_DURATION;
                updateTimerDisplay();

                if (moveToNext) {
                    if (difficulty === 'mirror') promptNextMirrorCountry();
                    else selectNextCountry();
                }

                timerInterval = setInterval(() => {
                    pacedTimeRemaining--;
                    updateTimerDisplay();
                    if (pacedTimeRemaining < 0) {
                        if (difficulty === 'mirror') {
                            const correctName = quizSequence[currentSequenceIndex].name;
                            const missedLayer = countryData[correctName];
                            if (missedLayer) missedLayer.setStyle(getStyle('incorrectFinished'));
                            promptNextMirrorCountry();
                        } else {
                            selectNextCountry();
                        }
                        startPacedTimer();
                    }
                }, 1000);
            }
            
            function updateTimerDisplay() {
                statusDisplayContainer.classList.add('hidden');
                timerProgressBar.style.display = 'none';
                
                let minutes, seconds;

                switch(playStyle) {
                    case 'explore':
                        statusDisplayContainer.classList.add('hidden');
                        break;
                    case 'zen':
                        statusDisplayContainer.classList.remove('hidden');
                        if (quizState === 'pre-start') zenTimeElapsed = 0;
                        minutes = Math.floor(zenTimeElapsed / 60);
                        seconds = zenTimeElapsed % 60;
                        timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        break;
                    case 'timed':
                        statusDisplayContainer.classList.remove('hidden');
                        if (quizState === 'pre-start') timeRemaining = 15 * 60;
                        minutes = Math.floor(timeRemaining / 60);
                        seconds = timeRemaining % 60;
                        timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        break;
                    case 'paced':
                        statusDisplayContainer.classList.remove('hidden');
                        timerProgressBar.style.display = 'block';
                        if (quizState === 'pre-start') pacedTimeRemaining = PACED_DURATION;
                        timerDisplay.textContent = `${pacedTimeRemaining}s`;
                        const pacedOffset = progressBarLength * (1 - (pacedTimeRemaining / PACED_DURATION));
                        timerProgressBar.style.strokeDashoffset = pacedOffset;
                        break;
                    case 'sprint':
                        statusDisplayContainer.classList.remove('hidden');
                        timerProgressBar.style.display = 'block';
                        updateComboMeter();
                        break;
                }
            }

            function stopAllTimers() {
                clearInterval(timerInterval);
                clearInterval(comboTimerInterval);
                clearInterval(hintRevealInterval);
                timerInterval = null;
                comboTimerInterval = null;
                hintRevealInterval = null;
            }

            // --- INFO MODAL LOGIC ---
            const settingsInfo = {
                playStyle: {
                    title: 'Play Style',
                    content: `
                        <p><strong>Explore:</strong> Freely browse the map, learn facts about each country, and take an optional mini-quiz.</p>
                        <p><strong>Timed:</strong> A 15-minute timer for the entire quiz.</p>
                        <p><strong>Paced:</strong> 15 seconds to guess each country.</p>
                        <p><strong>Sprint:</strong> A fast-paced mode with score multipliers for quick, consecutive answers.`
                },
                tabOrder: {
                    title: 'Tab Order',
                    content: `
                        <p><strong>Random:</strong> Countries are selected in a random order.</p>
                        <p><strong>Alphabetical:</strong> Countries are selected in alphabetical order.</p>
                        <p><strong>Path:</strong> Countries are selected following a logical geographical path across the globe. (Not available in Mirror mode).</p>`
                },
                difficulty: {
                    title: 'Difficulty',
                    content: `
                        <p><strong>Easy:</strong> Shows the first letter, the number of letters, and reveals a random letter every 3 seconds.</p>
                        <p><strong>Normal:</strong> Shows the first letter and underscores for the rest of the word.</p>
                        <p><strong>Hard:</strong> Shows only underscores representing the number of letters.</p>
                        <p><strong>Extreme:</strong> No hints are provided.</p>
                        <p><strong>Mirror:</strong> Click the prompted country on the map. You have 4 incorrect clicks per country. Get a country right in Timed mode to add 2 seconds to the clock.</p>`
                },
                theme: {
                    title: 'Theme',
                    content: `
                        <p><strong>Voyager:</strong> The classic, light-mode map.</p>
                        <p><strong>Midnight:</strong> A sleek, dark-mode theme.</p>
                        <p><strong>Earth:</strong> A terrain-focused, natural-color theme.</p>
                        <p><strong>Oceanic:</strong> A blue-hued theme emphasizing water bodies.`
                }
            };

            settingsPanel.addEventListener('click', (e) => {
                const icon = e.target.closest('.info-icon');
                if (icon) {
                    const settingKey = icon.dataset.setting;
                    const info = settingsInfo[settingKey];
                    if (info) {
                        infoModalTitle.textContent = info.title;
                        infoModalBody.innerHTML = info.content;
                        infoModal.classList.remove('hidden');
                        infoModal.classList.add('flex');
                        setTimeout(() => infoModal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
                    }
                }
            });

            closeInfoModalBtn.addEventListener('click', () => hideModal(infoModal));
            infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) {
                    hideModal(infoModal);
                }
            });

            // --- PROFILE PAGE EVENT LISTENERS ---
            profileBtn.addEventListener('click', () => {
                displayProfileStats();
                mainContainer.classList.add('hidden');
                profilePage.classList.remove('hidden');
            });

            closeProfileBtn.addEventListener('click', () => {
                mainContainer.classList.remove('hidden');
                profilePage.classList.add('hidden');
            });

            resetStatsBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to reset all your stats and achievements? This cannot be undone.")) {
                    profileStats = initializeDefaultStats();
                    saveProfileStats();
                    displayProfileStats();
                }
            });
        });
    </script>
</body>
</html>
